<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>المنصة الأكاديمية — مواد حسب السنوات + ملفات مع Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    *{font-family:'Cairo',sans-serif}
    .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .glass{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2)}
    .card{transition:transform .25s ease,box-shadow .25s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,.12)}
    .hidden{display:none!important} /* لضمان إخفاء شاشة التحميل حتى لو فشل CDN */
  </style>
</head>
<body class="bg-slate-50">
  <!-- شاشة تحميل آمنة -->
  <div id="loadingScreen" class="fixed inset-0 gradient-bg z-50 flex items-center justify-center">
    <div class="text-center text-white">
      <div class="mb-5"><i class="fas fa-graduation-cap text-6xl"></i></div>
      <div class="w-64 h-2 bg-white/25 rounded-full mx-auto overflow-hidden">
        <div id="loadingBar" class="h-2 bg-white rounded-full" style="width:0%"></div>
      </div>
      <p class="mt-3 opacity-95">جاري التحميل...</p>
    </div>
  </div>

  <!-- صفحة ترحيب -->
  <div id="landing" class="min-h-screen gradient-bg hidden">
    <nav class="glass p-4">
      <div class="max-w-6xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="fas fa-graduation-cap text-2xl text-purple-600"></i>
          <span class="text-xl font-bold text-slate-800">المنصة الأكاديمية</span>
        </div>
        <div class="flex gap-2">
          <button onclick="openSupabaseSettings()" class="px-4 py-2 rounded-lg text-purple-600 hover:bg-purple-50">
            <i class="fas fa-database ml-1"></i> إعدادات Supabase
          </button>
          <button onclick="openLogin()" class="px-4 py-2 rounded-lg bg-white text-purple-600 hover:bg-slate-100 font-semibold">
            تسجيل الدخول
          </button>
        </div>
      </div>
    </nav>

    <section class="max-w-6xl mx-auto px-4 py-20 text-center text-white">
      <h1 class="text-5xl md:text-6xl font-bold mb-4">سنوات → فصول → مواد → ملفات</h1>
      <p class="text-xl opacity-95 mb-8">أضف المواد وأرفق سلايدات/تلخيصات/ريكوردات. نحفظ المعرّفات من Supabase لمنع أخطاء الربط.</p>
      <button onclick="openLogin()" class="bg-white text-purple-600 px-8 py-3 rounded-full font-bold hover:bg-slate-100">ابدأ الآن</button>
    </section>
  </div>

  <!-- لوحة التحكم -->
  <div id="app" class="hidden">
    <!-- شريط علوي -->
    <header class="glass sticky top-0 z-30">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button onclick="toggleSidebar()" class="lg:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <span class="text-lg font-bold text-slate-800">لوحة المواد</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="connBadge" class="px-3 py-1 rounded-full text-xs bg-slate-200 text-slate-700">غير متصل</span>
          <button onclick="openSupabaseSettings()" class="px-3 py-2 rounded-lg text-purple-600 hover:bg-purple-50">
            <i class="fas fa-database ml-1"></i> إعدادات Supabase
          </button>
          <button onclick="logout()" class="px-3 py-2 rounded-lg text-rose-600 hover:bg-rose-50">
            <i class="fas fa-sign-out-alt ml-1"></i> خروج
          </button>
        </div>
      </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 py-6 grid lg:grid-cols-4 gap-6">
      <!-- جانب -->
      <aside id="sidebar" class="lg:col-span-1 glass p-4 rounded-2xl shadow card hidden lg:block">
        <div class="text-center mb-4">
          <div class="w-16 h-16 mx-auto rounded-full bg-gradient-to-br from-purple-500 to-indigo-500 text-white flex items-center justify-center text-2xl">
            <i class="fas fa-user"></i>
          </div>
          <div id="userName" class="font-bold text-slate-800 mt-2">المستخدم</div>
          <div id="userRole" class="text-sm text-slate-500">طالب</div>
        </div>

        <div class="space-y-2">
          <button onclick="showSection('subjects')" class="w-full text-right px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">
            <i class="fas fa-book ml-2"></i> المواد
          </button>
          <button onclick="syncSubjectsPull()" class="w-full text-right px-4 py-2 rounded-lg bg-slate-800 text-white hover:bg-slate-900">
            <i class="fas fa-rotate ml-2"></i> مزامنة المواد
          </button>
          <button onclick="pushOfflineSubjectsToSupabase()" class="w-full text-right px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">
            <i class="fas fa-cloud-arrow-up ml-2"></i> رفع المواد غير المتزامنة
          </button>
        </div>

        <div class="mt-6 p-4 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-xl text-white">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm opacity-90">عدد المواد</div>
              <div id="subjectsCount" class="text-2xl font-bold">0</div>
            </div>
            <div>
              <div class="text-sm opacity-90">عدد الملفات</div>
              <div id="filesCount" class="text-2xl font-bold">0</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- المحتوى -->
      <main class="lg:col-span-3">
        <!-- المواد -->
        <section id="subjectsSection" class="glass rounded-2xl p-4 md:p-6 shadow card">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-2xl font-bold text-slate-800">المواد الدراسية</h2>
              <p class="text-slate-600 text-sm">سنوات 1–6، كل سنة ثلاثة فصول. وقسم الجامعة (إجباري/حر).</p>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">حالة الإضافة</div>
              <div id="addModeState" class="text-sm font-semibold text-rose-600">المستخدمون: عرض فقط</div>
            </div>
          </div>

          <!-- أقسام عليا -->
          <div class="grid md:grid-cols-2 gap-4">
            <div class="p-4 rounded-xl bg-white border shadow-sm">
              <div class="text-center mb-2">
                <div class="w-12 h-12 mx-auto rounded-xl bg-gradient-to-br from-blue-500 to-indigo-500 text-white flex items-center justify-center">
                  <i class="fas fa-graduation-cap"></i>
                </div>
                <h3 class="font-bold text-slate-800 mt-2">السنوات الدراسية</h3>
                <p class="text-slate-600 text-sm">اضغط لفتح السنة والفصل</p>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                <button class="py-2 px-3 bg-blue-50 rounded-lg hover:bg-blue-100" onclick="openYear('year1')">السنة 1</button>
                <button class="py-2 px-3 bg-blue-50 rounded-lg hover:bg-blue-100" onclick="openYear('year2')">السنة 2</button>
                <button class="py-2 px-3 bg-blue-50 rounded-lg hover:bg-blue-100" onclick="openYear('year3')">السنة 3</button>
                <button class="py-2 px-3 bg-blue-50 rounded-lg hover:bg-blue-100" onclick="openYear('year4')">السنة 4</button>
                <button class="py-2 px-3 bg-blue-50 rounded-lg hover:bg-blue-100" onclick="openYear('year5')">السنة 5</button>
                <button class="py-2 px-3 bg-blue-50 rounded-lg hover:bg-blue-100" onclick="openYear('year6')">السنة 6</button>
              </div>
            </div>

            <div class="p-4 rounded-xl bg-white border shadow-sm">
              <div class="text-center mb-2">
                <div class="w-12 h-12 mx-auto rounded-xl bg-gradient-to-br from-emerald-500 to-teal-500 text-white flex items-center justify-center">
                  <i class="fas fa-university"></i>
                </div>
                <h3 class="font-bold text-slate-800 mt-2">مواد الجامعة</h3>
                <p class="text-slate-600 text-sm">إجباري/حر</p>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button class="py-2 px-3 bg-emerald-50 rounded-lg hover:bg-emerald-100" onclick="openUniversity('required')">إجباري</button>
                <button class="py-2 px-3 bg-emerald-50 rounded-lg hover:bg-emerald-100" onclick="openUniversity('elective')">حر</button>
              </div>
            </div>
          </div>

          <!-- محتوى السنة/الفصل -->
          <div id="yearPanel" class="mt-6 hidden">
            <div class="flex items-center justify-between mb-2">
              <div class="font-bold text-slate-800" id="yearPanelTitle">السنة</div>
              <div class="text-xs text-slate-500">اختر الفصل</div>
            </div>
            <div class="grid md:grid-cols-3 gap-3">
              <div class="p-3 rounded-xl bg-blue-50">
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-blue-800">الفصل الأول</div>
                  <button id="btnAdd_y_semester1" class="hidden text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700" onclick="openAddSubject('academic', currentYearKey, 'semester1')">
                    <i class="fas fa-plus ml-1"></i> إضافة
                  </button>
                </div>
                <div id="list_y_semester1" class="mt-2 space-y-2"></div>
              </div>
              <div class="p-3 rounded-xl bg-blue-50">
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-blue-800">الفصل الثاني</div>
                  <button id="btnAdd_y_semester2" class="hidden text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700" onclick="openAddSubject('academic', currentYearKey, 'semester2')">
                    <i class="fas fa-plus ml-1"></i> إضافة
                  </button>
                </div>
                <div id="list_y_semester2" class="mt-2 space-y-2"></div>
              </div>
              <div class="p-3 rounded-xl bg-blue-50">
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-blue-800">فصل صيفي</div>
                  <button id="btnAdd_y_summer" class="hidden text-sm bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700" onclick="openAddSubject('academic', currentYearKey, 'summer')">
                    <i class="fas fa-plus ml-1"></i> إضافة
                  </button>
                </div>
                <div id="list_y_summer" class="mt-2 space-y-2"></div>
              </div>
            </div>
          </div>

          <!-- محتوى الجامعة -->
          <div id="uniPanel" class="mt-6 hidden">
            <div class="grid md:grid-cols-2 gap-3">
              <div class="p-3 rounded-xl bg-emerald-50">
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-emerald-800">مواد إجبارية</div>
                  <button id="btnAdd_u_required" class="hidden text-sm bg-emerald-600 text-white px-3 py-1 rounded-lg hover:bg-emerald-700" onclick="openAddSubject('university', null, 'required')">
                    <i class="fas fa-plus ml-1"></i> إضافة
                  </button>
                </div>
                <div id="list_u_required" class="mt-2 space-y-2"></div>
              </div>
              <div class="p-3 rounded-xl bg-emerald-50">
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-emerald-800">مواد حرة</div>
                  <button id="btnAdd_u_elective" class="hidden text-sm bg-emerald-600 text-white px-3 py-1 rounded-lg hover:bg-emerald-700" onclick="openAddSubject('university', null, 'elective')">
                    <i class="fas fa-plus ml-1"></i> إضافة
                  </button>
                </div>
                <div id="list_u_elective" class="mt-2 space-y-2"></div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- نافذة إضافة مادة -->
  <div id="addSubjectModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="glass rounded-2xl p-6 w-full max-w-xl">
      <div class="flex items-center justify-between mb-3">
        <h3 id="addModalTitle" class="text-2xl font-bold text-slate-800">إضافة مادة</h3>
        <button onclick="closeAddModal()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg"><i class="fas fa-times"></i></button>
      </div>
      <p id="addModalSub" class="text-slate-600 mb-4 text-sm"></p>
      <form onsubmit="handleAddSubject(event)" class="grid gap-3">
        <input id="subName" class="px-4 py-3 border rounded-xl" placeholder="اسم المادة" required>
        <textarea id="subDesc" rows="3" class="px-4 py-3 border rounded-xl" placeholder="وصف مختصر" required></textarea>
        <div class="grid md:grid-cols-3 gap-2">
          <input id="subCode" class="px-3 py-2 border rounded-xl" placeholder="رمز (VET101)" required>
          <input id="subHours" type="number" min="1" max="6" class="px-3 py-2 border rounded-xl" placeholder="ساعات" required>
          <input id="subTeacher" class="px-3 py-2 border rounded-xl" placeholder="الأستاذ" required>
        </div>
        <div class="text-xs text-slate-500">مهم: عند الاتصال، سنحفظ المادة أولاً في Supabase ونعتمد المعرّف العائد منه.</div>
        <div class="flex gap-2 pt-1">
          <button class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold">إضافة</button>
          <button type="button" onclick="closeAddModal()" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white py-2 rounded-lg">إلغاء</button>
        </div>
      </form>
    </div>
  </div>

  <!-- نافذة تفاصيل المادة -->
  <div id="subjectModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="glass rounded-2xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 id="subjectTitle" class="text-2xl font-bold text-slate-800">المادة</h3>
        <button onclick="closeSubjectModal()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg"><i class="fas fa-times"></i></button>
      </div>
      <div id="subjectInfo" class="mb-4 text-slate-700"></div>
      <div class="grid md:grid-cols-3 gap-2">
        <button onclick="openFiles('slides')" class="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold"><i class="fas fa-presentation ml-1"></i> سلايدات</button>
        <button onclick="openFiles('summaries')" class="bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-bold"><i class="fas fa-file-alt ml-1"></i> تلخيصات</button>
        <button onclick="openFiles('recordings')" class="bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-bold"><i class="fas fa-microphone ml-1"></i> ريكوردات</button>
      </div>
    </div>
  </div>

  <!-- نافذة ملفات المادة -->
  <div id="filesModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="glass rounded-2xl p-6 w-full max-w-3xl">
      <div class="flex items-center justify-between mb-3">
        <h3 id="filesTitle" class="text-2xl font-bold text-slate-800">ملفات</h3>
        <button onclick="closeFilesModal()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg"><i class="fas fa-times"></i></button>
      </div>
      <div id="filesList" class="space-y-2"></div>
      <div class="text-center mt-3">
        <button id="btnAddFile" onclick="addNewFile()" class="hidden bg-purple-600 hover:bg-purple-700 text-white py-2 px-6 rounded-xl font-bold">
          <i class="fas fa-plus ml-1"></i> إضافة ملف
        </button>
      </div>
    </div>
  </div>

  <!-- إعدادات Supabase -->
  <div id="supabaseModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="glass rounded-2xl p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-2xl font-bold text-slate-800">إعدادات Supabase</h3>
        <button onclick="closeSupabaseSettings()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg"><i class="fas fa-times"></i></button>
      </div>
      <div class="grid gap-3">
        <div>
          <label class="block text-sm text-slate-700 mb-1">Project URL</label>
          <input id="sbUrl" class="w-full px-3 py-2 border rounded-lg" placeholder="https://xxxx.supabase.co">
        </div>
        <div>
          <label class="block text-sm text-slate-700 mb-1">Anon Key</label>
          <div class="flex">
            <input id="sbAnon" type="password" class="w-full px-3 py-2 border rounded-l-lg" placeholder="eyJhbGciOi...">
            <button onclick="toggleAnon()" class="px-3 py-2 bg-slate-100 border border-l-0 rounded-r-lg hover:bg-slate-200"><i id="anonEye" class="fas fa-eye"></i></button>
          </div>
        </div>
        <div class="text-xs text-slate-500">تُحفظ محلياً على جهازك فقط.</div>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="saveSupabaseSettings()" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold">حفظ والاتصال</button>
          <button onclick="testSupabaseConnection()" class="bg-slate-800 hover:bg-slate-900 text-white py-2 rounded-lg font-bold">اختبار الاتصال</button>
        </div>
      </div>
    </div>
  </div>

  <!-- تسجيل الدخول -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="glass rounded-2xl p-6 w-full max-w-md">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-2xl font-bold text-slate-800">تسجيل الدخول</h3>
        <button onclick="closeLogin()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-lg"><i class="fas fa-times"></i></button>
      </div>
      <form onsubmit="handleLogin(event)" class="grid gap-3">
        <input id="loginEmail" type="email" class="px-4 py-3 border rounded-xl" placeholder="example@vet.edu" required>
        <input id="loginPass" type="password" class="px-4 py-3 border rounded-xl" placeholder="••••••••" required>
        <button class="bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold">دخول</button>
        <div class="text-xs text-slate-500">لصلاحيات المدير جرّب البريد: admin@vet.edu مع أي كلمة مرور.</div>
      </form>
    </div>
  </div>

  <!-- تنبيهات -->
  <div id="toast" class="fixed top-4 left-4 z-50 hidden">
    <div id="toastBox" class="px-5 py-3 rounded-xl shadow text-white bg-blue-600">
      <i id="toastIcon" class="fas fa-info-circle ml-2"></i>
      <span id="toastText">...</span>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
  <script>
    // حالة عامة
    let supabaseClient = null;
    let currentUser = null;
    let isAdmin = false;

    // تنظيم المواد محلياً
    let organized = JSON.parse(localStorage.getItem('organizedSubjects') || 'null') || {
      academic: {
        year1:{semester1:[], semester2:[], summer:[]},
        year2:{semester1:[], semester2:[], summer:[]},
        year3:{semester1:[], semester2:[], summer:[]},
        year4:{semester1:{}, semester2:{}, summer:{}}
      }
    };
    // تأكد من السنوات الناقصة (حماية ضد تخزين قديم)
    ['year1','year2','year3','year4','year5','year6'].forEach(y=>{
      if(!organized.academic[y]) organized.academic[y] = {semester1:[], semester2:[], summer:[]};
    });
    if(!organized.university) organized.university = { required:[], elective:[] };

    // سياق إضافة مادة
    let addCtx = { category:null, yearKey:null, termOrType:null };
    // سياق عرض مادة وملفات
    let currentSubject = null;
    let currentFilesType = null;
    let currentYearKey = null;

    // بدء
    document.addEventListener('DOMContentLoaded', ()=>{
      // شريط التحميل
      let p=0; const int=setInterval(()=>{ p+=20; document.getElementById('loadingBar').style.width=p+'%'; if(p>=100){ clearInterval(int); document.getElementById('loadingScreen').style.display='none'; document.getElementById('landing').classList.remove('hidden'); }},120);
      // تحميل اتصال Supabase إن وجد
      initSupabaseFromStorage();
      // مظهر صلاحيات الإضافة
      updateAddModeState();
      // عدادات
      updateCounters();
    });

    // واجهة عامة
    function showToast(msg, type='info', detail=null){
      const t=document.getElementById('toast'), b=document.getElementById('toastBox'), i=document.getElementById('toastIcon'), s=document.getElementById('toastText');
      const map={success:['bg-emerald-600','fas fa-check-circle'], error:['bg-rose-600','fas fa-exclamation-circle'], info:['bg-blue-600','fas fa-info-circle']};
      b.className='px-5 py-3 rounded-xl shadow text-white '+map[type][0]; i.className=map[type][1]+' ml-2'; s.textContent=msg+(detail?(' — '+detail):'');
      t.classList.remove('hidden'); setTimeout(()=> t.classList.add('hidden'), 3200);
    }
    function openLogin(){ const m=document.getElementById('loginModal'); m.classList.remove('hidden'); m.classList.add('flex'); }
    function closeLogin(){ const m=document.getElementById('loginModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
    function handleLogin(e){
      e.preventDefault();
      const email=document.getElementById('loginEmail').value.trim();
      const pass=document.getElementById('loginPass').value.trim();
      if(!email||!pass) return;
      isAdmin = (email==='admin@vet.edu');
      currentUser = { email, name: email.split('@')[0] };
      document.getElementById('landing').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('sidebar').classList.remove('hidden');
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userRole').textContent = isAdmin ? 'مدير' : 'طالب';
      updateAddModeState();
      closeLogin();
      showSection('subjects');
      showToast('تم تسجيل الدخول','success');
    }
    function logout(){
      currentUser=null; isAdmin=false;
      document.getElementById('app').classList.add('hidden');
      document.getElementById('landing').classList.remove('hidden');
      updateAddModeState();
      showToast('تم تسجيل الخروج','info');
    }
    function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('hidden'); }
    function showSection(name){ if(name==='subjects'){ /* already on */ } }

    // إعدادات Supabase
    function openSupabaseSettings(){ const m=document.getElementById('supabaseModal'); m.classList.remove('hidden'); m.classList.add('flex'); document.getElementById('sbUrl').value=localStorage.getItem('supabase_url')||''; document.getElementById('sbAnon').value=localStorage.getItem('supabase_anon')||''; }
    function closeSupabaseSettings(){ const m=document.getElementById('supabaseModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
    function toggleAnon(){ const i=document.getElementById('sbAnon'), e=document.getElementById('anonEye'); if(i.type==='password'){ i.type='text'; e.className='fas fa-eye-slash'; } else { i.type='password'; e.className='fas fa-eye'; } }
    function saveSupabaseSettings(){
      const url=document.getElementById('sbUrl').value.trim(), anon=document.getElementById('sbAnon').value.trim();
      if(!url||!anon){ showToast('أدخل Project URL و Anon Key','error'); return; }
      localStorage.setItem('supabase_url', url); localStorage.setItem('supabase_anon', anon);
      initSupabaseFromStorage(true);
    }
    function initSupabaseFromStorage(showToastMsg=false){
      const url=localStorage.getItem('supabase_url'), anon=localStorage.getItem('supabase_anon');
      if(url && anon){ supabaseClient = window.supabase.createClient(url, anon); setConnBadge(true); if(showToastMsg) showToast('تم الاتصال','success'); }
      else { supabaseClient=null; setConnBadge(false); }
    }
    async function testSupabaseConnection(){
      if(!supabaseClient){ initSupabaseFromStorage(); if(!supabaseClient) return showToast('أدخل الإعدادات أولاً','error'); }
      try{
        const { error } = await supabaseClient.from('subjects').select('id').limit(1);
        if (error) throw error;
        setConnBadge(true); showToast('الاتصال ناجح','success');
      }catch(err){ setConnBadge(false); showErrorDetail('فشل الاتصال', err); }
    }
    function setConnBadge(connected){
      const b=document.getElementById('connBadge');
      if(connected){ b.textContent='متصل'; b.className='px-3 py-1 rounded-full text-xs bg-emerald-100 text-emerald-700'; }
      else { b.textContent='غير متصل'; b.className='px-3 py-1 rounded-full text-xs bg-slate-200 text-slate-700'; }
    }
    function showErrorDetail(message, err){
      // عرض رسالة مفصلة من Supabase إن وُجدت
      let detail='';
      if(err){
        if(err.message) detail += err.message;
        if(err.code) detail += ` [${err.code}]`;
      }
      showToast(message, 'error', detail||null);
      console.warn(message, err);
    }

    // تحديث صلاحيات الإضافة
    function updateAddModeState(){
      const el=document.getElementById('addModeState');
      el.textContent = isAdmin ? 'المدير: إضافة/حذف مسموحة' : 'المستخدمون: عرض فقط';
      // إظهار أزرار إضافة للمشرف
      ['btnAdd_y_semester1','btnAdd_y_semester2','btnAdd_y_summer','btnAdd_u_required','btnAdd_u_elective'].forEach(id=>{
        const b=document.getElementById(id); if(b) b.classList.toggle('hidden', !isAdmin);
      });
    }

    // فتح سنة
    function openYear(yearKey){
      currentYearKey = yearKey;
      const map={year1:'الأولى',year2:'الثانية',year3:'الثالثة',year4:'الرابعة',year5:'الخامسة',year6:'السادسة'};
      document.getElementById('yearPanelTitle').textContent = 'السنة '+(map[yearKey]||'');
      document.getElementById('yearPanel').classList.remove('hidden');
      document.getElementById('uniPanel').classList.add('hidden');
      // تحميل المواد للفصول
      renderSubjectsList('list_y_semester1', organized.academic[yearKey].semester1);
      renderSubjectsList('list_y_semester2', organized.academic[yearKey].semester2);
      renderSubjectsList('list_y_summer', organized.academic[yearKey].summer);
      updateAddModeState();
    }

    // فتح قسم الجامعة
    function openUniversity(type){
      document.getElementById('uniPanel').classList.remove('hidden');
      document.getElementById('yearPanel').classList.add('hidden');
      renderSubjectsList('list_u_required', organized.university.required);
      renderSubjectsList('list_u_elective', organized.university.elective);
      updateAddModeState();
    }

    // بطاقة مادة
    function subjectCard(sub){
      return `
        <div class="bg-white border rounded-xl p-3 hover:shadow flex items-start justify-between">
          <div class="flex-1 cursor-pointer" onclick="openSubject('${sub.id}')">
            <div class="font-bold text-slate-800">${sub.name}</div>
            <div class="text-sm text-slate-600">${sub.code||'-'} • ${sub.hours} ساعات</div>
            <div class="text-xs text-slate-500">${sub.teacher||''}${sub.id.startsWith('temp_')?' • غير متزامنة':''}</div>
          </div>
          <div class="flex gap-1">
            <button class="text-blue-600 hover:text-blue-800 p-1" title="السلايدات" onclick="event.stopPropagation(); quickFiles('${sub.id}','slides')"><i class="fas fa-presentation"></i></button>
            <button class="text-orange-600 hover:text-orange-800 p-1" title="التلخيصات" onclick="event.stopPropagation(); quickFiles('${sub.id}','summaries')"><i class="fas fa-file-alt"></i></button>
            <button class="text-emerald-600 hover:text-emerald-800 p-1" title="الريكوردات" onclick="event.stopPropagation(); quickFiles('${sub.id}','recordings')"><i class="fas fa-microphone"></i></button>
          </div>
        </div>
      `;
    }
    function renderSubjectsList(containerId, list){
      const c=document.getElementById(containerId); if(!c) return; c.innerHTML = (list||[]).map(subjectCard).join('') || `<div class="text-center text-slate-500 py-4 text-sm">لا توجد مواد</div>`;
      updateCounters();
    }

    // فتح نموذج إضافة مادة
    function openAddSubject(category, yearKey, termOrType){
      if(!isAdmin) return showToast('الإضافة للمدير فقط','error');
      addCtx = { category, yearKey, termOrType };
      const t=document.getElementById('addModalTitle'), s=document.getElementById('addModalSub');
      if(category==='academic'){
        const map={year1:'الأولى',year2:'الثانية',year3:'الثالثة',year4:'الرابعة',year5:'الخامسة',year6:'السادسة'};
        const tmap={semester1:'الأول',semester2:'الثاني',summer:'الصيفي'};
        t.textContent='إضافة مادة';
        s.textContent=`السنة ${map[yearKey]} • الفصل ${tmap[termOrType]}`;
      } else {
        s.textContent = (termOrType==='required' ? 'مواد إجبارية' : 'مواد حرة');
      }
      const m=document.getElementById('addSubjectModal'); m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeAddModal(){
      ['subName','subDesc','subCode','subHours','subTeacher'].forEach(id=>document.getElementById(id).value='');
      const m=document.getElementById('addSubjectModal'); m.classList.add('hidden'); m.classList.remove('flex');
    }
    // إضافة مادة: الأفضل — نحفظ أولاً في Supabase ونستخدم المعرف العائد
    async function handleAddSubject(e){
      e.preventDefault();
      const name=document.getElementById('subName').value.trim();
      const description=document.getElementById('subDesc').value.trim();
      const code=document.getElementById('subCode').value.trim();
      const hours=parseInt(document.getElementById('subHours').value);
      const teacher=document.getElementById('subTeacher').value.trim();
      if(!name||!description||!code||!hours||!teacher) return;

      let newSub = null;

      if(supabaseClient){
        try{
          const payload = {
            name, description, hours, code, teacher,
            category: addCtx.category,
            year: addCtx.category==='academic' ? parseInt(addCtx.yearKey.replace('year','')) : null,
            term: addCtx.category==='academic' ? addCtx.termOrType : null,
            uni_type: addCtx.category==='university' ? addCtx.termOrType : null,
            updated_at: new Date().toISOString()
          };
          const { data, error } = await supabaseClient.from('subjects').insert([payload]).select().limit(1);
          if (error) throw error;
          const row = (data && data[0]) ? data[0] : null;
          if(!row || !row.id) throw new Error('لم يتم استرجاع معرف المادة من الخادم');
          newSub = { id: row.id, name, description, code, hours, teacher };
          showToast('تمت إضافة المادة سحابياً','success');
        }catch(err){
          showErrorDetail('تعذر إضافة المادة', err);
          return; // لا نضيف محلياً عند فشل السحابي في النمط "الأفضل"
        }
      } else {
        // بدون اتصال: نضيف محلياً بمعرف مؤقت سيتم استبداله لاحقاً عند "رفع المواد غير المتزامنة"
        const tempId = 'temp_'+Date.now();
        newSub = { id: tempId, name, description, code, hours, teacher, _meta:{ category:addCtx.category, yearKey:addCtx.yearKey, termOrType:addCtx.termOrType } };
        showToast('تمت الإضافة محلياً (غير متزامنة)','info');
      }

      // ضعها في مكانها
      if(addCtx.category==='academic'){
        organized.academic[addCtx.yearKey][addCtx.termOrType].push(newSub);
        renderSubjectsList('list_y_'+addCtx.termOrType, organized.academic[addCtx.yearKey][addCtx.termOrType]);
      } else {
        organized.university[addCtx.termOrType].push(newSub);
        renderSubjectsList('list_u_'+addCtx.termOrType, organized.university[addCtx.termOrType]);
      }
      persistOrganized();
      updateCounters();
      closeAddModal();
    }

    // فتح تفاصيل مادة
    function openSubject(id){
      const s = findSubjectById(id); if(!s) return;
      currentSubject = s;
      const m=document.getElementById('subjectModal'); m.classList.remove('hidden'); m.classList.add('flex');
      document.getElementById('subjectTitle').textContent = s.name + (s.id.startsWith('temp_') ? ' — (غير متزامنة)' : '');
      document.getElementById('subjectInfo').innerHTML = `
        <div class="text-slate-700 mb-1">${s.description||''}</div>
        <div class="grid md:grid-cols-3 gap-2 text-sm text-slate-600">
          <div><i class="fas fa-code ml-1"></i> رمز: ${s.code||'-'}</div>
          <div><i class="fas fa-clock ml-1"></i> ساعات: ${s.hours||'-'}</div>
          <div><i class="fas fa-user ml-1"></i> أستاذ: ${s.teacher||'-'}</div>
        </div>`;
    }
    function closeSubjectModal(){ const m=document.getElementById('subjectModal'); m.classList.add('hidden'); m.classList.remove('flex'); }

    // فتح الملفات
    function quickFiles(subId, type){ const s=findSubjectById(subId); if(!s) return; currentSubject=s; openFiles(type); }
    async function openFiles(type){
      if(!currentSubject) return;
      currentFilesType = type;
      document.getElementById('filesTitle').textContent = `${type==='slides'?'السلايدات':type==='summaries'?'التلخيصات':'الريكوردات'} — ${currentSubject.name}`;
      const list=document.getElementById('filesList'); list.innerHTML=`<div class="text-slate-500 py-4">جاري التحميل...</div>`;
      const btnAdd=document.getElementById('btnAddFile');

      // التحكم في زر الإضافة
      const canAdd = isAdmin && !!supabaseClient && !String(currentSubject.id).startsWith('temp_');
      btnAdd.classList.toggle('hidden', !canAdd);

      if(String(currentSubject.id).startsWith('temp_')){
        list.innerHTML = `<div class="text-center text-slate-500 py-6">
          <i class="fas fa-triangle-exclamation text-2xl mb-2 text-rose-500"></i>
          <div>هذه المادة غير متزامنة بعد. اضغط "رفع المواد غير المتزامنة" ثم أعد المحاولة.</div>
        </div>`;
      } else if (!supabaseClient){
        list.innerHTML = `<div class="text-center text-slate-500 py-6">
          <i class="fas fa-plug text-2xl mb-2"></i>
          <div>أدخل إعدادات Supabase أولاً.</div>
        </div>`;
      } else {
        try{
          const { data, error } = await supabaseClient.from('subject_files')
            .select('*')
            .eq('subject_id', currentSubject.id)
            .eq('type', type)
            .order('created_at',{ascending:false});
          if (error) throw error;
          if(!data || !data.length){
            list.innerHTML = `<div class="text-center text-slate-500 py-6"><i class="fas fa-folder-open text-2xl mb-2"></i><div>لا توجد ملفات</div></div>`;
          } else {
            list.innerHTML = '';
            data.forEach(f=>{
              const row=document.createElement('div');
              row.className='flex items-center justify-between p-3 bg-slate-50 rounded-lg';
              row.innerHTML = `
                <div class="flex items-center">
                  <i class="fas fa-file text-slate-600 ml-3"></i>
                  <div>
                    <div class="font-semibold text-slate-800">${f.name}</div>
                    <div class="text-xs text-slate-500">${new Date(f.created_at).toLocaleString('ar-SA')}</div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <a href="${f.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800"><i class="fas fa-up-right-from-square"></i></a>
                  ${isAdmin?`<button class="text-rose-600 hover:text-rose-800" onclick="deleteFile('${f.id}')"><i class="fas fa-trash"></i></button>`:''}
                </div>`;
              list.appendChild(row);
            });
          }
        }catch(err){ showErrorDetail('تعذر تحميل الملفات', err); list.innerHTML = `<div class="text-center text-rose-600 py-4 text-sm">فشل التحميل.</div>`; }
      }

      const m=document.getElementById('filesModal'); m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeFilesModal(){ const m=document.getElementById('filesModal'); m.classList.add('hidden'); m.classList.remove('flex'); currentFilesType=null; }

    // إضافة ملف
    async function addNewFile(){
      if(!isAdmin) return showToast('الإضافة للمدير فقط','error');
      if(!supabaseClient) return showToast('أدخل إعدادات Supabase أولاً','error');
      if(!currentSubject || !currentFilesType) return;
      if(String(currentSubject.id).startsWith('temp_')) return showToast('هذه المادة غير متزامنة. ارفعها أولاً','error');

      const name = prompt('اسم الملف:'); if(!name) return;
      const url = prompt('رابط الملف (https):'); if(!url) return;
      if(!/^https?:\/\//i.test(url)) return showToast('الرابط يجب أن يبدأ بـ https://','error');

      try{
        const { error } = await supabaseClient.from('subject_files').insert([{ subject_id: currentSubject.id, type: currentFilesType, name, url }]);
        if (error) throw error;
        showToast('تمت إضافة الملف','success');
        openFiles(currentFilesType);
      }catch(err){ showErrorDetail('تعذر إضافة الملف', err); }
    }
    async function deleteFile(fileId){
      if(!confirm('حذف الملف؟')) return;
      try{
        const { error } = await supabaseClient.from('subject_files').delete().eq('id', fileId);
        if (error) throw error;
        showToast('تم حذف الملف','success');
        openFiles(currentFilesType);
      }catch(err){ showErrorDetail('تعذر حذف الملف', err); }
    }

    // مزامنة المواد من Supabase -> محلي
    async function syncSubjectsPull(){
      if(!supabaseClient) return showToast('أدخل إعدادات Supabase أولاً','error');
      try{
        const { data, error } = await supabaseClient.from('subjects').select('*').order('updated_at',{ascending:false}).limit(1500);
        if(error) throw error;
        const fresh = {
          academic: {
            year1:{semester1:[], semester2:[], summer:[]},
            year2:{semester1:[], semester2:[], summer:[]},
            year3:{semester1:[], semester2:[], summer:[]},
            year4:{semester1:[], semester2:[], summer:[]},
            year5:{semester1:[], semester2:[], summer:[]},
            year6:{semester1:[], semester2:[], summer:[]}
          },
          university: { required:[], elective:[] }
        };
        (data||[]).forEach(r=>{
          const sub = { id:r.id, name:r.name, description:r.description, code:r.code, hours:r.hours, teacher:r.teacher };
          if(r.category==='academic' && r.year && r.term){ const y='year'+r.year; fresh.academic[y][r.term].push(sub); }
          if(r.category==='university' && r.uni_type){ fresh.university[r.uni_type].push(sub); }
        });
        organized = fresh;
        persistOrganized();
        // إعادة العرض إذا لوحات مفتوحة
        if(currentYearKey) openYear(currentYearKey);
        else { renderSubjectsList('list_y_semester1', []); renderSubjectsList('list_y_semester2', []); renderSubjectsList('list_y_summer', []); }
        renderSubjectsList('list_u_required', organized.university.required);
        renderSubjectsList('list_u_elective', organized.university.elective);
        updateCounters();
        showToast('تمت مزامنة المواد','success');
      }catch(err){ showErrorDetail('تعذر مزامنة المواد', err); }
    }

    // رفع المواد غير المتزامنة: يستبدل temp_* بمعرّف Supabase الحقيقي
    async function pushOfflineSubjectsToSupabase(){
      if(!supabaseClient) return showToast('أدخل إعدادات Supabase أولاً','error');
      if(!isAdmin) return showToast('للمدير فقط','error');

      let pushed=0, replaced=0, errors=0;

      // دالة مساعدة لاستبدال المعرف داخل القوائم
      function replaceIdInList(list, oldId, newId){
        const idx=list.findIndex(s=>s.id===oldId);
        if(idx>-1){ list[idx].id=newId; if(list[idx]._meta) delete list[idx]._meta; replaced++; }
      }

      // ارفع في الأكاديمي
      for(const y of ['year1','year2','year3','year4','year5','year6']){
        for(const t of ['semester1','semester2','summer']){
          const arr=organized.academic[y][t];
          for(const s of [...arr]){
            if(String(s.id).startsWith('temp_') && s._meta){
              try{
                const payload={
                  name:s.name, description:s.description, hours:s.hours, code:s.code, teacher:s.teacher,
                  category:'academic', year:parseInt(y.replace('year','')), term:t, updated_at:new Date().toISOString()
                };
                const { data, error } = await supabaseClient.from('subjects').insert([payload]).select().limit(1);
                if(error) throw error;
                pushed++;
                const realId = data && data[0] && data[0].id;
                replaceIdInList(arr, s.id, realId);
              }catch(err){ errors++; showErrorDetail('فشل رفع مادة غير متزامنة', err); }
            }
          }
        }
      }
      // ارفع في الجامعة
      for(const k of ['required','elective']){
        const arr=organized.university[k];
        for(const s of [...arr]){
          if(String(s.id).startsWith('temp_') && s._meta){
            try{
              const payload={
                name:s.name, description:s.description, hours:s.hours, code:s.code, teacher:s.teacher,
                category:'university', uni_type:k, updated_at:new Date().toISOString()
              };
              const { data, error } = await supabaseClient.from('subjects').insert([payload]).select().limit(1);
              if(error) throw error;
              pushed++;
              const realId = data && data[0] && data[0].id;
              replaceIdInList(arr, s.id, realId);
            }catch(err){ errors++; showErrorDetail('فشل رفع مادة غير متزامنة', err); }
          }
        }
      }

      persistOrganized();
      if(currentYearKey) openYear(currentYearKey); else openUniversity('required');
      updateCounters();
      if(pushed>0 && errors===0) showToast(`تم رفع ${pushed} مادة غير متزامنة واستبدال معرفاتها`,`success`);
      else if (pushed>0) showToast(`تم رفع ${pushed} مادة، أخطاء: ${errors}`,'info');
      else showToast('لا توجد مواد غير متزامنة','info');
    }

    // أدوات مساعدة للمواد
    function persistOrganized(){ localStorage.setItem('organizedSubjects', JSON.stringify(organized)); }
    function findSubjectById(id){
      // أكاديمي
      for(const y of ['year1','year2','year3','year4','year5','year6']){
        for(const t of ['semester1','semester2','summer']){
          const f = organized.academic[y][t].find(s=>s.id===id);
          if(f) return f;
        }
      }
      // جامعة
      for(const k of ['required','elective']){
        const f = organized.university[k].find(s=>s.id===id);
        if(f) return f;
      }
      return null;
    }
    function updateCounters(){
      let total=0;
      for(const y of ['year1','year2','year3','year4','year5','year6']){
        for(const t of ['semester1','semester2','summer']) total += organized.academic[y][t].length;
      }
      total += organized.university.required.length + organized.university.elective.length;
      document.getElementById('subjectsCount').textContent = total;
      // عدد الملفات (سجّل آخر نتيجة فقط — لجلب العدد الحقيقي استخدم استعلام count من Supabase)
      document.getElementById('filesCount').textContent = document.getElementById('filesCount').textContent || '0';
    }

  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9846c6ef235232aa',t:'MTc1ODc2NDA0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
