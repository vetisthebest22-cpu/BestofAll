<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ุงูููุตุฉ ุงูุฃูุงุฏูููุฉ - ููุงุฏ ุญุณุจ ุงูุณููุงุช + Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    *{font-family:'Cairo',sans-serif}
    .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .gradient-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .glass-effect{background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
    .card-hover{transition:all .3s ease;transform:translateY(0)}
    .card-hover:hover{transform:translateY(-6px);box-shadow:0 16px 32px rgba(0,0,0,.12)}
    .nav-item.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;transform:scale(1.03)}
    .modal{animation:modalFadeIn .25s ease-out}
    @keyframes modalFadeIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
    .progress-bar{transition:width .6s ease}
    .notification{transition:transform .5s ease}
  </style>
</head>
<body class="bg-gray-50">
  <!-- Loading -->
  <div id="loadingScreen" class="fixed inset-0 gradient-bg z-50 flex items-center justify-center">
    <div class="text-center text-white">
      <div class="mb-4">
        <i class="fas fa-graduation-cap text-6xl"></i>
      </div>
      <div class="w-64 bg-white/20 rounded-full h-2 mx-auto">
        <div id="loadingProgress" class="bg-white h-2 rounded-full progress-bar" style="width:0%"></div>
      </div>
      <p class="opacity-90 mt-4">ุฌุงุฑู ุงูุชุญููู...</p>
    </div>
  </div>

  <!-- Landing -->
  <div id="landingPage" class="min-h-screen gradient-bg hidden">
    <nav class="glass-effect p-4">
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center">
          <i class="fas fa-graduation-cap text-2xl text-purple-600 ml-3"></i>
          <span class="text-xl font-bold text-gray-800">ุงูููุตุฉ ุงูุฃูุงุฏูููุฉ</span>
        </div>
        <div class="flex gap-3">
          <button onclick="showLoginForm()" class="bg-white text-purple-600 px-6 py-2 rounded-full font-semibold hover:bg-gray-100">ุชุณุฌูู ุงูุฏุฎูู</button>
          <button onclick="showSignupForm()" class="border-2 border-white text-white px-6 py-2 rounded-full font-semibold hover:bg-white hover:text-purple-600">ุฅูุดุงุก ุญุณุงุจ</button>
        </div>
      </div>
    </nav>

    <section class="container mx-auto px-4 py-20 text-center text-white">
      <h1 class="text-5xl md:text-6xl font-bold mb-4"> ุงูููุตุฉ ุงูุฃูุงุฏูููุฉ - ูุฌูุฉ ุงูุทุจ ูุงูุฌุฑุงุญุฉ ุงูุจูุทุฑูุฉ</h1>
      <p class="text-xl opacity-95 mb-8">ูุฑุญุจูุง ุจู ูู ุงููููุน ุงูุฑุณูู ููุฌูุฉ ุงูุทุจ ูุงูุฌุฑุงุญุฉ ุงูุจูุทุฑูุฉ ๐
ุฑูููู ุงูุฏุฑุงุณู ุงููุซุงูู ูุน ุฌููุน ุงููุตุงุฏุฑ ุงููุงุฒูุฉ ูุฑุญูุชู ุงูุฃูุงุฏูููุฉ ๐ฑ</p>
      <button onclick="showLoginForm()" class="bg-white text-purple-600 px-10 py-4 rounded-full font-bold hover:bg-gray-100">ุงุจุฏุฃ ุงูุขู</button>
    </section>
  </div>

  <!-- Auth: Login -->
  <div id="loginForm" class="fixed inset-0 bg-black/50 z-40 hidden items-center justify-center">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 modal">
      <h3 class="text-3xl font-bold text-gray-800 mb-2 text-center">ุชุณุฌูู ุงูุฏุฎูู</h3>
      <p class="text-gray-600 text-center mb-6">ุงุณุชุฎุฏู admin@vet.edu ูุชุฌุฑุจุฉ ุตูุงุญูุงุช ุงููุฏูุฑ</p>
      <form onsubmit="handleLogin(event)" class="space-y-4">
        <div>
          <label class="block text-sm text-gray-700 mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
          <input id="loginEmail" type="email" required class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="example@vet.edu">
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ</label>
          <input id="loginPassword" type="password" required class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="โขโขโขโขโขโขโขโข">
        </div>
        <button class="w-full gradient-card text-white py-3 rounded-xl font-bold hover:opacity-90">ุฏุฎูู</button>
        <button type="button" onclick="hideAuthForms()" class="w-full text-gray-600 hover:text-gray-800">ุฅูุบุงุก</button>
      </form>
    </div>
  </div>

  <!-- Auth: Signup -->
  <div id="signupForm" class="fixed inset-0 bg-black/50 z-40 hidden items-center justify-center">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full mx-4 modal">
      <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">ุฅูุดุงุก ุญุณุงุจ</h3>
      <form onsubmit="handleSignup(event)" class="space-y-4">
        <div>
          <label class="block text-sm text-gray-700 mb-1">ุงูุงุณู ุงููุงูู</label>
          <input id="signupName" required class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500">
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
          <input id="signupEmail" type="email" required class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500">
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">ุงูุณูุฉ ุงูุฏุฑุงุณูุฉ</label>
          <select id="signupYear" required class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="">ุงุฎุชุฑ ุงูุณูุฉ</option>
            <option value="1">ุงูุฃููู</option><option value="2">ุงูุซุงููุฉ</option><option value="3">ุงูุซุงูุซุฉ</option>
            <option value="4">ุงูุฑุงุจุนุฉ</option><option value="5">ุงูุฎุงูุณุฉ</option><option value="6">ุงูุณุงุฏุณุฉ</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ</label>
          <input id="signupPassword" type="password" required class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500">
        </div>
        <button class="w-full gradient-card text-white py-3 rounded-xl font-bold hover:opacity-90">ุฅูุดุงุก</button>
        <button type="button" onclick="hideAuthForms()" class="w-full text-gray-600 hover:text-gray-800">ุฅูุบุงุก</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <header class="glass-effect sticky top-0 z-30 shadow-lg border-b border-gray-200">
      <div class="flex items-center justify-between px-6 py-4">
        <div class="flex items-center gap-2">
          <button onclick="toggleSidebar()" class="lg:hidden text-gray-600 hover:text-gray-800 p-2 rounded-lg hover:bg-gray-100">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <div class="hidden md:flex items-center relative">
            <input type="text" placeholder="ุงุจุญุซ..." class="pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="supabaseStatusBadge" class="px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-700">ุบูุฑ ูุชุตู</span>
          <button onclick="openSupabaseSettings()" class="px-3 py-2 rounded-lg text-purple-600 hover:bg-purple-50"><i class="fas fa-database mr-1"></i> ุฅุนุฏุงุฏุงุช Supabase</button>
          <button onclick="toggleTheme()" class="p-2 text-gray-600 hover:text-gray-800 rounded-lg hover:bg-gray-100"><i id="themeIcon" class="fas fa-moon text-xl"></i></button>
          <div class="relative">
            <button onclick="toggleUserMenu()" class="flex items-center text-gray-700 hover:text-gray-900 p-2 rounded-lg hover:bg-gray-100">
              <i class="fas fa-chevron-down ml-2 text-sm"></i>
              <span id="userName" class="ml-2 hidden md:block font-semibold">ุงููุณุชุฎุฏู</span>
              <i class="fas fa-user-circle text-2xl"></i>
            </button>
            <div id="userMenu" class="absolute right-0 mt-2 w-56 glass-effect rounded-xl shadow-lg hidden">
              <div class="py-2">
                <a href="#" onclick="openSupabaseSettings()" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg mx-2"><i class="fas fa-database mr-2"></i>ุฅุนุฏุงุฏุงุช Supabase</a>
                <hr class="my-2 mx-2">
                <a href="#" onclick="logout()" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg mx-2"><i class="fas fa-sign-out-alt mr-2"></i>ุชุณุฌูู ุงูุฎุฑูุฌ</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="flex">
      <!-- Sidebar -->
      <aside id="sidebar" class="glass-effect w-64 min-h-screen shadow-xl lg:translate-x-0 fixed lg:relative z-20 translate-x-full lg:translate-x-0 right-0 lg:right-auto">
        <nav class="p-6">
          <div class="mb-8 text-center">
            <div id="userAvatar" class="w-16 h-16 gradient-card rounded-full flex items-center justify-center mx-auto mb-3">
              <i class="fas fa-user text-2xl text-white"></i>
            </div>
            <h3 id="sidebarUserName" class="font-bold text-gray-800">ูุฑุญุจุงู ุจู</h3>
            <p id="userRole" class="text-sm text-gray-600">ุทุงูุจ</p>
          </div>
          <ul class="space-y-3">
            <li><button onclick="showSection('home')" class="nav-item active w-full text-right px-4 py-3 rounded-xl hover:bg-purple-50 hover:text-purple-600 flex items-center"><i class="fas fa-home ml-3"></i><span class="font-semibold">ุงูุฑุฆูุณูุฉ</span></button></li>
            <li><button onclick="showSection('subjects')" class="nav-item w-full text-right px-4 py-3 rounded-xl hover:bg-purple-50 hover:text-purple-600 flex items-center"><i class="fas fa-book ml-3"></i><span class="font-semibold">ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</span></button></li>
            <li><button onclick="showSection('tools')" class="nav-item w-full text-right px-4 py-3 rounded-xl hover:bg-purple-50 hover:text-purple-600 flex items-center"><i class="fas fa-tools ml-3"></i><span class="font-semibold">ุงูุฃุฏูุงุช</span></button></li>
            <li><button onclick="showSection('messages')" class="nav-item w-full text-right px-4 py-3 rounded-xl hover:bg-purple-50 hover:text-purple-600 flex items-center"><i class="fas fa-comments ml-3"></i><span class="font-semibold">ุงูุฑุณุงุฆู</span></button></li>
            <li id="adminNav" class="hidden"><button onclick="showSection('admin')" class="nav-item w-full text-right px-4 py-3 rounded-xl hover:bg-red-50 hover:text-red-600 flex items-center"><i class="fas fa-shield-alt ml-3"></i><span class="font-semibold">ููุญุฉ ุงูุฅุฏุงุฑุฉ</span></button></li>
          </ul>

          <div class="mt-8 p-4 gradient-card rounded-xl text-white">
            <h4 class="font-bold mb-3">ุงููุฒุงููุฉ</h4>
            <div class="space-y-2">
              <div class="flex gap-2">
                <button onclick="syncSubjects()" class="flex-1 bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg">ูุฒุงููุฉ ุงูููุงุฏ</button>
                <button onclick="syncFilesPreview()" class="flex-1 bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg">ุชุญูู ุงููููุงุช</button>
              </div>
              <label class="inline-flex items-center">
                <input type="checkbox" id="realtimeToggle" class="ml-2" onchange="toggleRealtime(this.checked)">
                <span class="text-sm">ุชุญุฏูุซ ููุฑู ููุฑุณุงุฆู</span>
              </label>
            </div>
          </div>
        </nav>
      </aside>

      <!-- Main -->
      <main class="flex-1 p-6 overflow-y-auto">
        <!-- Home -->
        <section id="homeSection" class="section">
          <div class="mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-2">ูุฑุญุจุงู ุจู</h2>
            <p class="text-gray-600">ูู ุดูุก ููุธู: ุณููุงุชุ ูุตููุ ููุงุฏ ูููุงุฑุฏ. ูุนูู Supabase ูู ุงูุฅุนุฏุงุฏุงุช ูููุฒุงููุฉ.</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-effect rounded-2xl p-6 card-hover">
              <div class="flex items-center">
                <div class="w-12 h-12 gradient-card rounded-xl flex items-center justify-center"><i class="fas fa-database text-white"></i></div>
                <div class="mr-4">
                  <div id="syncStatusText" class="text-2xl font-bold text-gray-800">Offline</div>
                  <div class="text-gray-600">ุญุงูุฉ ุงูุงุชุตุงู</div>
                </div>
              </div>
              <div class="mt-4 flex gap-2">
                <button onclick="openSupabaseSettings()" class="px-3 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">ุฅุนุฏุงุฏุงุช</button>
                <button onclick="syncAll()" class="px-3 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">ูุฒุงููุฉ ูุงููุฉ</button>
              </div>
            </div>
            <div class="glass-effect rounded-2xl p-6 card-hover">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center"><i class="fas fa-book text-white"></i></div>
                <div class="mr-4">
                  <div id="subjectsCounter" class="text-2xl font-bold text-gray-800">0</div>
                  <div class="text-gray-600">ูุงุฏุฉ</div>
                </div>
              </div>
            </div>
            <div class="glass-effect rounded-2xl p-6 card-hover">
              <div class="flex items-center">
                <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center"><i class="fas fa-file text-white"></i></div>
                <div class="mr-4">
                  <div id="filesCounter" class="text-2xl font-bold text-gray-800">0</div>
                  <div class="text-gray-600">ููู</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Subjects -->
        <section id="subjectsSection" class="section hidden">
          <div class="mb-8">
            <h2 class="text-4xl font-bold text-gray-800 mb-2">ุงูููุงุฏ ุงูุฏุฑุงุณูุฉ</h2>
            <p class="text-gray-600">ููุณูุฉ ุญุณุจ ุงูุณููุงุช ูุงููุตููุ ููุณู ุฎุงุต ูููุงุฏ ุงูุฌุงูุนุฉ.</p>
          </div>

          <!-- Main Categories -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Academic Years -->
            <div class="glass-effect rounded-2xl p-6 card-hover cursor-pointer" onclick="toggleCategory('academicYears')">
              <div class="text-center">
                <div class="w-16 h-16 gradient-card rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="fas fa-graduation-cap text-3xl text-white"></i></div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">ุงูุณููุงุช ุงูุฏุฑุงุณูุฉ</h3>
                <p class="text-gray-600 mb-2">ุงูุณูุฉ 1 ุฅูู ุงูุณูุฉ 6ุ ุจูู ูุตู</p>
                <div class="text-purple-600 font-semibold">ุนุฑุถ ุงูุณููุงุช <i id="academicYearsIcon" class="fas fa-chevron-down mr-1"></i></div>
              </div>
            </div>
            <!-- University Subjects -->
            <div class="glass-effect rounded-2xl p-6 card-hover cursor-pointer" onclick="toggleCategory('universitySubjects')">
              <div class="text-center">
                <div class="w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="fas fa-university text-3xl text-white"></i></div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">ููุงุฏ ุงูุฌุงูุนุฉ</h3>
                <p class="text-gray-600 mb-2">ููุงุฏ ุฅุฌุจุงุฑูุฉ ูููุงุฏ ุญุฑุฉ</p>
                <div class="text-green-600 font-semibold">ุนุฑุถ ุงูููุงุฏ <i id="universitySubjectsIcon" class="fas fa-chevron-down mr-1"></i></div>
              </div>
            </div>
          </div>

          <!-- Academic Years Content -->
          <div id="academicYearsContent" class="hidden">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ุงูุณููุงุช ุงูุฏุฑุงุณูุฉ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- Year Cards 1..6 -->
              <div class="glass-effect rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-book text-white"></i></div>
                  <h4 class="text-xl font-bold text-gray-800">ุงูุณูุฉ ุงูุฃููู</h4>
                </div>
                <div class="space-y-3">
                  <button onclick="toggleSemester('year1','semester1')" class="w-full bg-blue-100 text-blue-800 py-2 px-4 rounded-lg hover:bg-blue-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุฃูู</span><i id="year1semester1Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year1semester1Content" class="hidden space-y-2 pr-2">
                    <div id="year1semester1Subjects" class="space-y-2"></div>
                    <button id="addBtn_year1_semester1" onclick="showAddSubjectModal('academic','year1','semester1')" class="hidden w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year1','semester2')" class="w-full bg-blue-100 text-blue-800 py-2 px-4 rounded-lg hover:bg-blue-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุซุงูู</span><i id="year1semester2Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year1semester2Content" class="hidden space-y-2 pr-2">
                    <div id="year1semester2Subjects" class="space-y-2"></div>
                    <button id="addBtn_year1_semester2" onclick="showAddSubjectModal('academic','year1','semester2')" class="hidden w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year1','summer')" class="w-full bg-blue-100 text-blue-800 py-2 px-4 rounded-lg hover:bg-blue-200 flex items-center justify-between">
                    <span>ูุตู ุตููู</span><i id="year1summerIcon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year1summerContent" class="hidden space-y-2 pr-2">
                    <div id="year1summerSubjects" class="space-y-2"></div>
                    <button id="addBtn_year1_summer" onclick="showAddSubjectModal('academic','year1','summer')" class="hidden w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>
                </div>
              </div>

              <!-- Duplicate template with different colors/titles for years 2..6 -->
              <div class="glass-effect rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-book text-white"></i></div>
                  <h4 class="text-xl font-bold text-gray-800">ุงูุณูุฉ ุงูุซุงููุฉ</h4>
                </div>
                <div class="space-y-3">
                  <button onclick="toggleSemester('year2','semester1')" class="w-full bg-green-100 text-green-800 py-2 px-4 rounded-lg hover:bg-green-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุฃูู</span><i id="year2semester1Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year2semester1Content" class="hidden space-y-2 pr-2">
                    <div id="year2semester1Subjects" class="space-y-2"></div>
                    <button id="addBtn_year2_semester1" onclick="showAddSubjectModal('academic','year2','semester1')" class="hidden w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year2','semester2')" class="w-full bg-green-100 text-green-800 py-2 px-4 rounded-lg hover:bg-green-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุซุงูู</span><i id="year2semester2Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year2semester2Content" class="hidden space-y-2 pr-2">
                    <div id="year2semester2Subjects" class="space-y-2"></div>
                    <button id="addBtn_year2_semester2" onclick="showAddSubjectModal('academic','year2','semester2')" class="hidden w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year2','summer')" class="w-full bg-green-100 text-green-800 py-2 px-4 rounded-lg hover:bg-green-200 flex items-center justify-between">
                    <span>ูุตู ุตููู</span><i id="year2summerIcon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year2summerContent" class="hidden space-y-2 pr-2">
                    <div id="year2summerSubjects" class="space-y-2"></div>
                    <button id="addBtn_year2_summer" onclick="showAddSubjectModal('academic','year2','summer')" class="hidden w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>
                </div>
              </div>

              <div class="glass-effect rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-book text-white"></i></div>
                  <h4 class="text-xl font-bold text-gray-800">ุงูุณูุฉ ุงูุซุงูุซุฉ</h4>
                </div>
                <div class="space-y-3">
                  <button onclick="toggleSemester('year3','semester1')" class="w-full bg-purple-100 text-purple-800 py-2 px-4 rounded-lg hover:bg-purple-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุฃูู</span><i id="year3semester1Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year3semester1Content" class="hidden space-y-2 pr-2">
                    <div id="year3semester1Subjects" class="space-y-2"></div>
                    <button id="addBtn_year3_semester1" onclick="showAddSubjectModal('academic','year3','semester1')" class="hidden w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year3','semester2')" class="w-full bg-purple-100 text-purple-800 py-2 px-4 rounded-lg hover:bg-purple-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุซุงูู</span><i id="year3semester2Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year3semester2Content" class="hidden space-y-2 pr-2">
                    <div id="year3semester2Subjects" class="space-y-2"></div>
                    <button id="addBtn_year3_semester2" onclick="showAddSubjectModal('academic','year3','semester2')" class="hidden w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year3','summer')" class="w-full bg-purple-100 text-purple-800 py-2 px-4 rounded-lg hover:bg-purple-200 flex items-center justify-between">
                    <span>ูุตู ุตููู</span><i id="year3summerIcon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year3summerContent" class="hidden space-y-2 pr-2">
                    <div id="year3summerSubjects" class="space-y-2"></div>
                    <button id="addBtn_year3_summer" onclick="showAddSubjectModal('academic','year3','summer')" class="hidden w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>
                </div>
              </div>

              <div class="glass-effect rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-book text-white"></i></div>
                  <h4 class="text-xl font-bold text-gray-800">ุงูุณูุฉ ุงูุฑุงุจุนุฉ</h4>
                </div>
                <div class="space-y-3">
                  <button onclick="toggleSemester('year4','semester1')" class="w-full bg-red-100 text-red-800 py-2 px-4 rounded-lg hover:bg-red-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุฃูู</span><i id="year4semester1Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year4semester1Content" class="hidden space-y-2 pr-2">
                    <div id="year4semester1Subjects" class="space-y-2"></div>
                    <button id="addBtn_year4_semester1" onclick="showAddSubjectModal('academic','year4','semester1')" class="hidden w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year4','semester2')" class="w-full bg-red-100 text-red-800 py-2 px-4 rounded-lg hover:bg-red-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุซุงูู</span><i id="year4semester2Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year4semester2Content" class="hidden space-y-2 pr-2">
                    <div id="year4semester2Subjects" class="space-y-2"></div>
                    <button id="addBtn_year4_semester2" onclick="showAddSubjectModal('academic','year4','semester2')" class="hidden w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year4','summer')" class="w-full bg-red-100 text-red-800 py-2 px-4 rounded-lg hover:bg-red-200 flex items-center justify-between">
                    <span>ูุตู ุตููู</span><i id="year4summerIcon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year4summerContent" class="hidden space-y-2 pr-2">
                    <div id="year4summerSubjects" class="space-y-2"></div>
                    <button id="addBtn_year4_summer" onclick="showAddSubjectModal('academic','year4','summer')" class="hidden w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>
                </div>
              </div>

              <div class="glass-effect rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-book text-white"></i></div>
                  <h4 class="text-xl font-bold text-gray-800">ุงูุณูุฉ ุงูุฎุงูุณุฉ</h4>
                </div>
                <div class="space-y-3">
                  <button onclick="toggleSemester('year5','semester1')" class="w-full bg-orange-100 text-orange-800 py-2 px-4 rounded-lg hover:bg-orange-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุฃูู</span><i id="year5semester1Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year5semester1Content" class="hidden space-y-2 pr-2">
                    <div id="year5semester1Subjects" class="space-y-2"></div>
                    <button id="addBtn_year5_semester1" onclick="showAddSubjectModal('academic','year5','semester1')" class="hidden w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year5','semester2')" class="w-full bg-orange-100 text-orange-800 py-2 px-4 rounded-lg hover:bg-orange-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุซุงูู</span><i id="year5semester2Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year5semester2Content" class="hidden space-y-2 pr-2">
                    <div id="year5semester2Subjects" class="space-y-2"></div>
                    <button id="addBtn_year5_semester2" onclick="showAddSubjectModal('academic','year5','semester2')" class="hidden w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year5','summer')" class="w-full bg-orange-100 text-orange-800 py-2 px-4 rounded-lg hover:bg-orange-200 flex items-center justify-between">
                    <span>ูุตู ุตููู</span><i id="year5summerIcon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year5summerContent" class="hidden space-y-2 pr-2">
                    <div id="year5summerSubjects" class="space-y-2"></div>
                    <button id="addBtn_year5_summer" onclick="showAddSubjectModal('academic','year5','summer')" class="hidden w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>
                </div>
              </div>

              <div class="glass-effect rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="w-12 h-12 bg-indigo-500 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-book text-white"></i></div>
                  <h4 class="text-xl font-bold text-gray-800">ุงูุณูุฉ ุงูุณุงุฏุณุฉ</h4>
                </div>
                <div class="space-y-3">
                  <button onclick="toggleSemester('year6','semester1')" class="w-full bg-indigo-100 text-indigo-800 py-2 px-4 rounded-lg hover:bg-indigo-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุฃูู</span><i id="year6semester1Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year6semester1Content" class="hidden space-y-2 pr-2">
                    <div id="year6semester1Subjects" class="space-y-2"></div>
                    <button id="addBtn_year6_semester1" onclick="showAddSubjectModal('academic','year6','semester1')" class="hidden w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year6','semester2')" class="w-full bg-indigo-100 text-indigo-800 py-2 px-4 rounded-lg hover:bg-indigo-200 flex items-center justify-between">
                    <span>ุงููุตู ุงูุซุงูู</span><i id="year6semester2Icon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year6semester2Content" class="hidden space-y-2 pr-2">
                    <div id="year6semester2Subjects" class="space-y-2"></div>
                    <button id="addBtn_year6_semester2" onclick="showAddSubjectModal('academic','year6','semester2')" class="hidden w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>

                  <button onclick="toggleSemester('year6','summer')" class="w-full bg-indigo-100 text-indigo-800 py-2 px-4 rounded-lg hover:bg-indigo-200 flex items-center justify-between">
                    <span>ูุตู ุตููู</span><i id="year6summerIcon" class="fas fa-chevron-down"></i>
                  </button>
                  <div id="year6summerContent" class="hidden space-y-2 pr-2">
                    <div id="year6summerSubjects" class="space-y-2"></div>
                    <button id="addBtn_year6_summer" onclick="showAddSubjectModal('academic','year6','summer')" class="hidden w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- University Subjects Content -->
          <div id="universitySubjectsContent" class="hidden mt-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ููุงุฏ ุงูุฌุงูุนุฉ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Required -->
              <div class="glass-effect rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-exclamation-circle text-white"></i></div>
                  <h4 class="text-xl font-bold text-gray-800">ุงูููุงุฏ ุงูุฅุฌุจุงุฑูุฉ</h4>
                </div>
                <button onclick="toggleUniversityCategory('required')" class="w-full bg-red-100 text-red-800 py-2 px-4 rounded-lg hover:bg-red-200 flex items-center justify-between">
                  <span>ุนุฑุถ ุงูููุงุฏ ุงูุฅุฌุจุงุฑูุฉ</span><i id="requiredIcon" class="fas fa-chevron-down"></i>
                </button>
                <div id="requiredContent" class="hidden space-y-2 pr-2 mt-2">
                  <div id="requiredSubjects" class="space-y-2"></div>
                  <button id="addBtn_university_required" onclick="showAddSubjectModal('university',null,'required')" class="hidden w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                </div>
              </div>
              <!-- Elective -->
              <div class="glass-effect rounded-2xl p-6">
                <div class="text-center mb-4">
                  <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3"><i class="fas fa-hand-pointer text-white"></i></div>
                  <h4 class="text-xl font-bold text-gray-800">ุงูููุงุฏ ุงูุญุฑุฉ</h4>
                </div>
                <button onclick="toggleUniversityCategory('elective')" class="w-full bg-blue-100 text-blue-800 py-2 px-4 rounded-lg hover:bg-blue-200 flex items-center justify-between">
                  <span>ุนุฑุถ ุงูููุงุฏ ุงูุญุฑุฉ</span><i id="electiveIcon" class="fas fa-chevron-down"></i>
                </button>
                <div id="electiveContent" class="hidden space-y-2 pr-2 mt-2">
                  <div id="electiveSubjects" class="space-y-2"></div>
                  <button id="addBtn_university_elective" onclick="showAddSubjectModal('university',null,'elective')" class="hidden w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"><i class="fas fa-plus ml-1"></i> ุฅุถุงูุฉ ูุงุฏุฉ</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Tools (brief) -->
        <section id="toolsSection" class="section hidden">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">ุงูุฃุฏูุงุช</h2>
            <p class="text-gray-600">ุญุงุณุจุฉ GPAุ ูุคูุชุ ูููุงู.</p>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- GPA -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
              <h3 class="text-2xl font-bold text-gray-800 text-center mb-6">ุญุงุณุจุฉ ุงููุนุฏู (GPA)</h3>
              <div class="space-y-3">
                <input type="text" id="gpaSubjectName" placeholder="ุงุณู ุงููุงุฏุฉ" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="creditHours" placeholder="ุนุฏุฏ ุงูุณุงุนุงุช" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="grade" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">ุงุฎุชุฑ ุงูุฏุฑุฌุฉ</option>
                  <option value="4.2">A+ (4.2)</option><option value="4.0">A (4.0)</option><option value="3.75">A- (3.75)</option>
                  <option value="3.5">B+ (3.5)</option><option value="3.25">B (3.25)</option><option value="3.0">B- (3.0)</option>
                  <option value="2.75">C+ (2.75)</option><option value="2.5">C (2.5)</option><option value="2.25">C- (2.25)</option>
                  <option value="2.0">D+ (2.0)</option><option value="1.75">D (1.75)</option><option value="1.5">D- (1.5)</option>
                  <option value="0.5">F (0.5)</option>
                </select>
                <button onclick="addSubjectToGPA()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">ุฅุถุงูุฉ</button>
              </div>
              <div id="gpaSubjects" class="mt-6 space-y-2"></div>
              <div class="text-center mt-6 p-4 gradient-card rounded-xl text-white">
                <div id="gpaResult" class="text-3xl font-bold">0.00</div>
                <div class="text-sm opacity-90">ุงููุนุฏู ุงูุชุฑุงููู</div>
              </div>
            </div>
            <!-- Pomodoro -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
              <h3 class="text-2xl font-bold text-gray-800 text-center mb-6">ูุคูุช ุจูููุฏูุฑู</h3>
              <div class="text-center mb-2">
                <div id="timerDisplay" class="text-4xl font-bold text-red-600">25:00</div>
              </div>
              <div class="flex justify-center gap-2">
                <button onclick="startTimer()" class="bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700"><i class="fas fa-play"></i></button>
                <button onclick="pauseTimer()" class="bg-yellow-500 text-white px-4 py-2 rounded-xl hover:bg-yellow-600"><i class="fas fa-pause"></i></button>
                <button onclick="resetTimer()" class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700"><i class="fas fa-stop"></i></button>
              </div>
              <div class="mt-4 space-y-2">
                <input id="customMinutes" type="number" min="1" max="60" placeholder="ุฏูุงุฆู ูุฎุตุตุฉ" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500">
                <button onclick="setCustomTimer()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700">ุชุนููู ูุคูุช</button>
              </div>
            </div>
            <!-- Tasks -->
            <div class="glass-effect rounded-2xl p-6 card-hover">
              <h3 class="text-2xl font-bold text-gray-800 text-center mb-6">ูุงุฆูุฉ ุงูููุงู</h3>
              <div class="space-y-3 mb-4">
                <input id="newTask" placeholder="ุฃุถู ูููุฉ ุฌุฏูุฏุฉ" class="w-full px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500">
                <div class="flex gap-2">
                  <button onclick="addTask()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700">ุฅุถุงูุฉ</button>
                </div>
              </div>
              <div id="tasksList" class="space-y-3 max-h-64 overflow-y-auto"></div>
            </div>
          </div>
        </section>

        <!-- Messages (kept minimal) -->
        <section id="messagesSection" class="section hidden">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">ุงูุฑุณุงุฆู</h2>
            <p class="text-gray-600">ุชุญุฏูุซ ููุฑู ุนูุฏ ุชูุนููู.</p>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
              <div class="glass-effect rounded-2xl p-6">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-xl font-bold text-gray-800">ุงููุญุงุฏุซุงุช</h3>
                  <button onclick="refreshGroups()" class="px-3 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-800"><i class="fas fa-rotate"></i></button>
                </div>
                <div id="chatsList" class="space-y-3"></div>
              </div>
            </div>
            <div class="lg:col-span-2">
              <div class="glass-effect rounded-2xl p-6 h-96 flex flex-col">
                <div id="chatHeader" class="flex items-center pb-4 border-b border-gray-200 mb-4">
                  <div class="w-10 h-10 bg-gray-400 rounded-full flex items-center justify-center"><i class="fas fa-comment text-white"></i></div>
                  <div class="mr-3">
                    <div class="font-semibold text-gray-800">ุงุฎุชุฑ ูุญุงุฏุซุฉ</div>
                    <div class="text-sm text-gray-600">ูุจุฏุก ุงููุฑุงุณูุฉ</div>
                  </div>
                </div>
                <div id="chatMessages" class="flex-1 overflow-y-auto mb-4">
                  <div class="text-center text-gray-500 mt-16">
                    <i class="fas fa-comments text-4xl mb-4"></i>
                    <p>ุงุฎุชุฑ ูุญุงุฏุซุฉ ูู ุงููุงุฆูุฉ ููุจุฏุก</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <input id="messageInput" type="text" placeholder="ุงูุชุจ ุฑุณุงูุชู..." class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500" disabled>
                  <button onclick="sendMessage()" id="sendButton" class="bg-purple-600 text-white p-2 rounded-full hover:bg-purple-700 disabled:opacity-50" disabled><i class="fas fa-paper-plane"></i></button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Admin (for demo: users/subjects quick forms) -->
        <section id="adminSection" class="section hidden">
          <div class="mb-6">
            <h2 class="text-3xl font-bold text-red-600 mb-1">ููุญุฉ ุงูุฅุฏุงุฑุฉ</h2>
            <p class="text-gray-600">ุงูุฅุถุงูุฉ ูุชุงุญุฉ ูููุฏูุฑ ููุท ูู ูุงุฌูุฉ ุงูุณููุงุช/ุงูุฌุงูุนุฉ.</p>
          </div>
          <div class="glass-effect rounded-2xl p-6">
            <p class="text-gray-700">ุฅู ููุช ูุชุตูุงู ุจู Supabaseุ ุณุชูุญูุธ ุงูููุงุฏ ูุงููููุงุช ูู ุงูุฌุฏุงูู ุงูุณุญุงุจูุฉ.</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Add Subject Modal -->
  <div id="addSubjectModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="glass-effect rounded-2xl p-6 max-w-lg w-full mx-4 modal">
      <div class="flex items-center justify-between mb-4">
        <h3 id="modalTitle" class="text-2xl font-bold text-gray-800">ุฅุถุงูุฉ ูุงุฏุฉ</h3>
        <button onclick="closeAddSubjectModal()" class="text-gray-600 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
      </div>
      <p id="modalSubtitle" class="text-gray-600 mb-4"></p>
      <form onsubmit="addSubjectToCategory(event)" class="grid gap-3">
        <input id="modalSubjectName" placeholder="ุงุณู ุงููุงุฏุฉ" class="px-4 py-3 border rounded-xl" required>
        <textarea id="modalSubjectDescription" placeholder="ูุตู ูุฎุชุตุฑ" class="px-4 py-3 border rounded-xl" rows="3" required></textarea>
        <div class="grid grid-cols-3 gap-2">
          <input id="modalSubjectCode" placeholder="ุฑูุฒ ุงููุงุฏุฉ (ูุซู VET101)" class="px-3 py-2 border rounded-xl" required>
          <input id="modalSubjectHours" type="number" min="1" max="6" placeholder="ุณุงุนุงุช" class="px-3 py-2 border rounded-xl" required>
          <input id="modalSubjectTeacher" placeholder="ุงูุฃุณุชุงุฐ" class="px-3 py-2 border rounded-xl" required>
        </div>
        <div class="flex gap-2 pt-2">
          <button class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">ุฅุถุงูุฉ</button>
          <button type="button" onclick="closeAddSubjectModal()" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">ุฅูุบุงุก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Subject Details Modal -->
  <div id="subjectDetailsModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="glass-effect rounded-2xl p-6 max-w-2xl w-full mx-4 modal">
      <div class="flex items-center justify-between mb-4">
        <h3 id="subjectDetailsTitle" class="text-2xl font-bold text-gray-800">ุชูุงุตูู ุงููุงุฏุฉ</h3>
        <button onclick="closeSubjectDetailsModal()" class="text-gray-600 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div id="subjectDetailsContent" class="mb-4"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <button onclick="openSubjectFiles('slides')" class="bg-blue-600 text-white py-3 px-4 rounded-xl font-bold hover:bg-blue-700"><i class="fas fa-presentation ml-1"></i>ุงูุณูุงูุฏุงุช</button>
        <button onclick="openSubjectFiles('summaries')" class="bg-orange-500 text-white py-3 px-4 rounded-xl font-bold hover:bg-orange-600"><i class="fas fa-file-alt ml-1"></i>ุงูุชูุงุฎูุต</button>
        <button onclick="openSubjectFiles('recordings')" class="bg-green-600 text-white py-3 px-4 rounded-xl font-bold hover:bg-green-700"><i class="fas fa-microphone ml-1"></i>ุงูุฑูููุฑุฏุงุช</button>
      </div>
    </div>
  </div>

  <!-- Subject Files Modal -->
  <div id="subjectFilesModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="glass-effect rounded-2xl p-6 max-w-3xl w-full mx-4 modal">
      <div class="flex items-center justify-between mb-4">
        <h3 id="filesModalTitle" class="text-2xl font-bold text-gray-800">ูููุงุช ุงููุงุฏุฉ</h3>
        <button onclick="closeSubjectFilesModal()" class="text-gray-600 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div id="subjectFilesContent" class="space-y-2"></div>
      <div class="text-center mt-4">
        <button id="addFileBtn" onclick="addNewFile()" class="hidden bg-purple-600 text-white py-2 px-6 rounded-xl font-bold hover:bg-purple-700"><i class="fas fa-plus ml-1"></i>ุฅุถุงูุฉ ููู</button>
      </div>
    </div>
  </div>

  <!-- Supabase Settings Modal -->
  <div id="supabaseSettingsModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="glass-effect rounded-2xl p-6 max-w-lg w-full mx-4 modal">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-bold text-gray-800">ุฅุนุฏุงุฏุงุช Supabase</h3>
        <button onclick="closeSupabaseSettings()" class="text-gray-600 hover:text-gray-800"><i class="fas fa-times text-xl"></i></button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="block text-sm text-gray-700 mb-1">Project URL</label>
          <input id="supabaseUrlInput" class="w-full px-3 py-2 border rounded-lg" placeholder="https://xxxx.supabase.co">
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">Anon Key</label>
          <div class="flex">
            <input id="supabaseAnonInput" type="password" class="w-full px-3 py-2 border rounded-l-lg" placeholder="eyJhbGciOi...">
            <button onclick="toggleAnonVisibility()" class="px-3 py-2 bg-gray-100 border border-l-0 rounded-r-lg hover:bg-gray-200"><i id="anonEye" class="fas fa-eye"></i></button>
          </div>
        </div>
        <div class="text-xs text-gray-500">ูุชู ุชุฎุฒูู ุงูุฅุนุฏุงุฏุงุช ูุญููุงู ููุท ุนูู ุฌูุงุฒู.</div>
        <div class="flex gap-2 pt-1">
          <button onclick="saveSupabaseSettings()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">ุญูุธ ูุงูุงุชุตุงู</button>
          <button onclick="testSupabaseConnection()" class="flex-1 bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-800">ุงุฎุชุจุงุฑ ุงูุงุชุตุงู</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="notification" class="fixed top-4 left-4 px-6 py-4 rounded-xl shadow-lg transform -translate-y-full z-50 bg-blue-600 text-white">
    <div class="flex items-center">
      <i id="notificationIcon" class="fas fa-info-circle text-xl ml-3"></i>
      <span id="notificationText" class="font-semibold">...</span>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
  <script>
    // State
    let currentUser=null, isAdmin=false;
    let supabaseClient=null, realtimeEnabled=true, activeRealtimeChannel=null;
    let tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
    let gpaEntries = JSON.parse(localStorage.getItem('gpaEntries')||'[]');

    // Subjects organized structure
    let organizedSubjects = JSON.parse(localStorage.getItem('organizedSubjects')) || {
      academic: {
        year1:{semester1:[], semester2:[], summer:[]},
        year2:{semester1:[], semester2:[], summer:[]},
        year3:{semester1:[], semester2:[], summer:[]},
        year4:{semester1:[], semester2:[], summer:[]},
        year5:{semester1:[], semester2:[], summer:[]},
        year6:{semester1:[], semester2:[], summer:[]}
      },
      university: { required:[], elective:[] }
    };

    // Currently selected for modals
    let currentModalContext = {category:null, yearKey:null, termOrType:null};
    let currentSubjectForFiles = null;
    let currentFileType = null;

    // Loading
    window.addEventListener('DOMContentLoaded', ()=>{
      let p=0, t=setInterval(()=>{
        p+=25; document.getElementById('loadingProgress').style.width=p+'%';
        if(p>=100){ clearInterval(t); document.getElementById('loadingScreen').classList.add('hidden'); document.getElementById('landingPage').classList.remove('hidden'); }
      },150);

      // Restore theme and realtime
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme==='dark'){ document.body.classList.add('dark'); document.getElementById('themeIcon').className='fas fa-sun text-xl'; }
      const savedRT = localStorage.getItem('realtimeEnabled'); if (savedRT!==null) realtimeEnabled = savedRT==='true';
      const rtToggle = document.getElementById('realtimeToggle'); if (rtToggle) rtToggle.checked = realtimeEnabled;

      initSupabaseFromStorage();
      updateCounters();
      loadTasks();
      updateGPA();
    });

    // UI helpers
    function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('translate-x-full'); }
    function toggleUserMenu(){ document.getElementById('userMenu').classList.toggle('hidden'); }
    function toggleTheme(){
      document.body.classList.toggle('dark');
      const isDark=document.body.classList.contains('dark');
      localStorage.setItem('theme', isDark?'dark':'light');
      document.getElementById('themeIcon').className = isDark?'fas fa-sun text-xl':'fas fa-moon text-xl';
    }
    function showNotification(msg,type='info'){
      const n=document.getElementById('notification'), icon=document.getElementById('notificationIcon'), text=document.getElementById('notificationText');
      const types={success:{icon:'fas fa-check-circle',bg:'bg-green-600'},error:{icon:'fas fa-exclamation-circle',bg:'bg-red-600'},info:{icon:'fas fa-info-circle',bg:'bg-blue-600'}};
      n.className = `fixed top-4 left-4 px-6 py-4 rounded-xl shadow-lg transform z-50 ${types[type].bg} text-white`;
      n.style.transform='translateY(0)'; icon.className=types[type].icon+' text-xl ml-3'; text.textContent=msg;
      setTimeout(()=>{ n.style.transform='translateY(-150%)'; }, 2800);
    }
    function showLoginForm(){ const m=document.getElementById('loginForm'); m.classList.remove('hidden'); m.classList.add('flex'); }
    function showSignupForm(){ const m=document.getElementById('signupForm'); m.classList.remove('hidden'); m.classList.add('flex'); }
    function hideAuthForms(){ ['loginForm','signupForm'].forEach(id=>{const m=document.getElementById(id); m.classList.add('hidden'); m.classList.remove('flex');}) }
    function showSection(name){
      document.querySelectorAll('.section').forEach(s=>s.classList.add('hidden'));
      document.getElementById(name+'Section').classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
      const btn = document.querySelector(`[onclick="showSection('${name}')"]`); if (btn) btn.classList.add('active');
      if (name==='subjects'){ refreshSubjectsUI(); }
      if (name==='messages'){ loadChatGroups(); }
    }

    // Auth (demo)
    function handleLogin(e){
      e.preventDefault();
      const email=document.getElementById('loginEmail').value;
      const password=document.getElementById('loginPassword').value;
      if (!email || !password) return;
      if (email==='admin@vet.edu'){ currentUser={email,name:'ุงููุฏูุฑ ุงูุนุงู',role:'admin'}; isAdmin=true; }
      else { currentUser={email,name:email.split('@')[0],role:'student', year:'3'}; isAdmin=false; }
      document.getElementById('landingPage').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('userName').textContent=currentUser.name;
      document.getElementById('sidebarUserName').textContent=currentUser.name;
      document.getElementById('userRole').textContent=isAdmin?'ูุฏูุฑ ุงููุธุงู':'ุทุงูุจ';
      document.getElementById('adminNav').classList.toggle('hidden',!isAdmin);
      showSection('subjects');
      showNotification('ุชู ุชุณุฌูู ุงูุฏุฎูู','success');
    }
    function handleSignup(e){
      e.preventDefault();
      const name=document.getElementById('signupName').value;
      const email=document.getElementById('signupEmail').value;
      const year=document.getElementById('signupYear').value;
      currentUser={name,email,role:'student',year}; isAdmin=false;
      document.getElementById('landingPage').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('userName').textContent=currentUser.name;
      document.getElementById('sidebarUserName').textContent=currentUser.name;
      document.getElementById('userRole').textContent='ุทุงูุจ';
      showSection('subjects');
      showNotification('ุชู ุฅูุดุงุก ุงูุญุณุงุจ','success');
    }
    function logout(){
      currentUser=null; isAdmin=false;
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('landingPage').classList.remove('hidden');
      showNotification('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ','info');
    }

    // Supabase settings
    function openSupabaseSettings(){
      const m=document.getElementById('supabaseSettingsModal'); m.classList.remove('hidden'); m.classList.add('flex');
      document.getElementById('supabaseUrlInput').value=localStorage.getItem('supabase_url')||'';
      document.getElementById('supabaseAnonInput').value=localStorage.getItem('supabase_anon')||'';
    }
    function closeSupabaseSettings(){ const m=document.getElementById('supabaseSettingsModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
    function toggleAnonVisibility(){ const i=document.getElementById('supabaseAnonInput'), e=document.getElementById('anonEye'); if(i.type==='password'){i.type='text';e.className='fas fa-eye-slash'}else{i.type='password';e.className='fas fa-eye'} }
    function saveSupabaseSettings(){
      const url=document.getElementById('supabaseUrlInput').value.trim();
      const anon=document.getElementById('supabaseAnonInput').value.trim();
      if(!url||!anon){ showNotification('ุฃุฏุฎู Project URL ู Anon Key','error'); return; }
      localStorage.setItem('supabase_url',url); localStorage.setItem('supabase_anon',anon);
      initSupabaseFromStorage(true);
    }
    function initSupabaseFromStorage(showToast=false){
      const url=localStorage.getItem('supabase_url'), anon=localStorage.getItem('supabase_anon');
      if (url && anon){ supabaseClient = window.supabase.createClient(url, anon); setConnectedState(true); if(showToast)showNotification('ุชู ุงูุงุชุตุงู','success'); }
      else { supabaseClient=null; setConnectedState(false); }
    }
    async function testSupabaseConnection(){
      try{
        if (!supabaseClient){ initSupabaseFromStorage(); if(!supabaseClient){ showNotification('ุฃุฏุฎู ุงูุฅุนุฏุงุฏุงุช ุฃููุงู','error'); return; } }
        const { error } = await supabaseClient.from('subjects').select('id').limit(1);
        if (error) throw error;
        showNotification('ุงูุงุชุตุงู ูุงุฌุญ','success'); setConnectedState(true);
      }catch(e){ console.warn(e); showNotification('ูุดู ุงูุงุชุตุงู. ุชุญูู ูู ุงูุฌุฏุงูู ูุงูุตูุงุญูุงุช','error'); setConnectedState(false); }
    }
    function setConnectedState(connected){
      const badge=document.getElementById('supabaseStatusBadge'), text=document.getElementById('syncStatusText');
      if (connected){ badge.textContent='ูุชุตู'; badge.className='px-3 py-1 text-xs rounded-full bg-green-100 text-green-700'; text.textContent='Online'; }
      else { badge.textContent='ุบูุฑ ูุชุตู'; badge.className='px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-700'; text.textContent='Offline'; teardownRealtime(); }
    }
    function toggleRealtime(on){ realtimeEnabled=on; localStorage.setItem('realtimeEnabled',String(on)); if(on) setupRealtime(); else teardownRealtime(); }

    // Messages (minimal)
    let chatGroups = JSON.parse(localStorage.getItem('chatGroups')||'[]');
    let chatMessages = { admin:[{sender:'admin',message:'ูุฑุญุจุงู!',time:'ุงูุขู'}] };
    function loadChatGroups(){
      const list=document.getElementById('chatsList'); if(!list) return; list.innerHTML='';
      const adminItem=document.createElement('div');
      adminItem.className='flex items-center p-3 hover:bg-gray-50 rounded-xl cursor-pointer';
      adminItem.onclick=()=>openChat('admin');
      adminItem.innerHTML=`<div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center"><i class="fas fa-shield-alt text-white"></i></div>
        <div class="mr-3 flex-1"><div class="font-semibold text-gray-800">ุงูุฅุฏุงุฑุฉ</div><div class="text-sm text-gray-600">ูุฑุญุจุงู ููู ูุณุงุนุฏูุ</div></div>
        <div class="text-xs text-gray-500">ุงูุขู</div>`;
      list.appendChild(adminItem);
      chatGroups.forEach(g=>{
        const item=document.createElement('div');
        item.className='flex items-center p-3 hover:bg-gray-50 rounded-xl cursor-pointer';
        item.onclick=()=>openChat(g.id);
        item.innerHTML=`<div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center"><i class="fas fa-users text-white"></i></div>
          <div class="mr-3 flex-1"><div class="font-semibold text-gray-800">${g.name}</div><div class="text-sm text-gray-600">${g.lastMessage||''}</div></div>
          <div class="text-xs text-gray-500">${g.lastMessageTime||''}</div>`;
        list.appendChild(item);
      });
    }
    function timeFromISO(iso){ try{const d=new Date(iso); return d.toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'});}catch{return 'ุงูุขู'} }
    async function openChat(chatId){
      const header=document.getElementById('chatHeader'); const input=document.getElementById('messageInput'); const send=document.getElementById('sendButton');
      if (chatId==='admin'){
        header.innerHTML=`<div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center"><i class="fas fa-shield-alt text-white"></i></div>
          <div class="mr-3"><div class="font-semibold text-gray-800">ุงูุฅุฏุงุฑุฉ</div><div class="text-sm text-gray-600">ูุชุงุญ ุงูุขู</div></div>`;
        loadChatMessages('admin');
      } else {
        const g = chatGroups.find(x=>x.id===chatId);
        header.innerHTML=`<div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center"><i class="fas fa-users text-white"></i></div>
          <div class="mr-3"><div class="font-semibold text-gray-800">${g?.name||'ูุฌููุนุฉ'}</div><div class="text-sm text-gray-600">${g?.members?.length||0} ุนุถู</div></div>`;
        if (supabaseClient){
          try{
            const { data } = await supabaseClient.from('messages').select('*').eq('group_id', g.id).order('created_at', {ascending:true}).limit(100);
            chatMessages[g.id] = (data||[]).map(m=>({sender:m.sender||'ุนุถู', message:m.content, time: timeFromISO(m.created_at)}));
          }catch(e){/* ignore */}
        }
        loadChatMessages(g.id);
      }
      input.disabled=false; send.disabled=false; input.focus();
      if (realtimeEnabled) setupRealtime();
    }
    function loadChatMessages(chatId){
      const c=document.getElementById('chatMessages'); const msgs=chatMessages[chatId]||[];
      c.innerHTML=''; msgs.forEach(m=>appendMessage(m,false)); c.scrollTop=c.scrollHeight;
    }
    function appendMessage(m,scroll=true){
      const c=document.getElementById('chatMessages'); const isUser=m.sender==='user'||m.isUser;
      const wrap=document.createElement('div'); wrap.className=`mb-3 ${isUser?'text-left':'text-right'}`;
      wrap.innerHTML=`<div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${isUser?'bg-purple-600 text-white':'bg-gray-200 text-gray-800'}">
        ${!isUser && m.sender && m.sender!=='admin'?`<div class="text-xs font-semibold mb-1">${m.sender}</div>`:''}
        <div>${m.message}</div><div class="text-xs opacity-75 mt-1">${m.time||timeFromISO(new Date().toISOString())}</div></div>`;
      c.appendChild(wrap); if (scroll) c.scrollTop=c.scrollHeight;
    }
    async function sendMessage(){
      const input=document.getElementById('messageInput'); const text=input.value.trim(); if(!text) return;
      const headerName=document.getElementById('chatHeader').innerText;
      let currentId=null; if (headerName.includes('ุงูุฅุฏุงุฑุฉ')) currentId='admin';
      else { // find any opened group by last open; not tracked here for brevity
        // not critical for this demo
      }
      currentId = currentId || (chatGroups[0]?.id);
      if (!currentId){ showNotification('ุงุฎุชุฑ ูุญุงุฏุซุฉ ุฃููุงู','error'); return; }
      if (!chatMessages[currentId]) chatMessages[currentId]=[];
      const mine={sender:'user', message:text, time: timeFromISO(new Date().toISOString()), isUser:true};
      chatMessages[currentId].push(mine); appendMessage(mine); input.value='';
      const g = chatGroups.find(x=>x.id===currentId);
      if (supabaseClient && g){
        try{ await supabaseClient.from('messages').insert([{group_id:g.id, content:text, sender: currentUser?.name||'ูุณุชุฎุฏู'}]); }catch(e){/* ignore */}
      }
    }
    function setupRealtime(){
      if (!supabaseClient) return;
      teardownRealtime();
      activeRealtimeChannel = supabaseClient.channel('public:messages')
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, payload=>{
          const msg=payload.new; const groupId=msg.group_id; if (!chatMessages[groupId]) chatMessages[groupId]=[];
          chatMessages[groupId].push({sender:msg.sender||'ุนุถู', message:msg.content, time: timeFromISO(msg.created_at)});
          const header=document.getElementById('chatHeader').innerText; if (header.includes('ุงูุฅุฏุงุฑุฉ') && groupId!=='admin') return;
          loadChatMessages(groupId);
        }).subscribe();
    }
    function teardownRealtime(){ if (activeRealtimeChannel){ activeRealtimeChannel.unsubscribe(); activeRealtimeChannel=null; } }

    // Subjects UI interactions
    function toggleCategory(cat){
      const content=document.getElementById(cat+'Content'); const icon=document.getElementById(cat+'Icon');
      if (content.classList.contains('hidden')){ content.classList.remove('hidden'); icon?.classList.add('rotate-180'); }
      else { content.classList.add('hidden'); icon?.classList.remove('rotate-180'); }
    }
    function toggleSemester(yearKey, term){
      const content=document.getElementById(yearKey+term+'Content'); const icon=document.getElementById(yearKey+term+'Icon');
      if (content.classList.contains('hidden')){ content.classList.remove('hidden'); icon?.classList.add('rotate-180'); loadSemesterSubjects(yearKey, term); }
      else { content.classList.add('hidden'); icon?.classList.remove('rotate-180'); }
    }
    function toggleUniversityCategory(type){
      const content=document.getElementById(type+'Content'); const icon=document.getElementById(type+'Icon');
      if (content.classList.contains('hidden')){ content.classList.remove('hidden'); icon?.classList.add('rotate-180'); loadUniversityCategorySubjects(type); }
      else { content.classList.add('hidden'); icon?.classList.remove('rotate-180'); }
    }

    function refreshSubjectsUI(){
      // show/hide admin add buttons
      const adminBtns = [
        'addBtn_year1_semester1','addBtn_year1_semester2','addBtn_year1_summer',
        'addBtn_year2_semester1','addBtn_year2_semester2','addBtn_year2_summer',
        'addBtn_year3_semester1','addBtn_year3_semester2','addBtn_year3_summer',
        'addBtn_year4_semester1','addBtn_year4_semester2','addBtn_year4_summer',
        'addBtn_year5_semester1','addBtn_year5_semester2','addBtn_year5_summer',
        'addBtn_year6_semester1','addBtn_year6_semester2','addBtn_year6_summer',
        'addBtn_university_required','addBtn_university_elective'
      ];
      adminBtns.forEach(id=>{ const b=document.getElementById(id); if (b) b.classList.toggle('hidden', !isAdmin); });
      updateCounters();
    }

    function subjectCardHTML(sub){
      return `
        <div class="bg-white border border-gray-200 rounded-lg p-3 hover:shadow transition">
          <div class="flex items-start justify-between">
            <div class="flex-1 cursor-pointer" onclick="viewSubjectDetails('${sub.id}')">
              <h5 class="font-bold text-gray-800">${sub.name}</h5>
              <p class="text-sm text-gray-600">${sub.code||'-'} โข ${sub.hours} ุณุงุนุงุช</p>
              <p class="text-xs text-gray-500">${sub.teacher||''}</p>
            </div>
            <div class="flex gap-1">
              <button onclick="quickOpenFiles(event,'${sub.id}','slides')" class="text-blue-600 hover:text-blue-800 p-1" title="ุงูุณูุงูุฏุงุช"><i class="fas fa-presentation"></i></button>
              <button onclick="quickOpenFiles(event,'${sub.id}','summaries')" class="text-orange-600 hover:text-orange-800 p-1" title="ุงูุชูุงุฎูุต"><i class="fas fa-file-alt"></i></button>
              <button onclick="quickOpenFiles(event,'${sub.id}','recordings')" class="text-green-600 hover:text-green-800 p-1" title="ุงูุฑูููุฑุฏุงุช"><i class="fas fa-microphone"></i></button>
            </div>
          </div>
        </div>`;
    }

    function loadSemesterSubjects(yearKey, term){
      const container=document.getElementById(yearKey+term+'Subjects');
      const list = organizedSubjects.academic[yearKey][term] || [];
      container.innerHTML = list.map(subjectCardHTML).join('');
      updateCounters();
    }
    function loadUniversityCategorySubjects(type){
      const container=document.getElementById(type+'Subjects');
      const list = organizedSubjects.university[type] || [];
      container.innerHTML = list.map(subjectCardHTML).join('');
      updateCounters();
    }

    function showAddSubjectModal(category, yearKey, termOrType){
      if (!isAdmin){ showNotification('ุงูุฅุถุงูุฉ ูููุฏูุฑ ููุท','error'); return; }
      currentModalContext = {category, yearKey, termOrType};
      const m=document.getElementById('addSubjectModal'); m.classList.remove('hidden'); m.classList.add('flex');
      const title=document.getElementById('modalTitle'), subtitle=document.getElementById('modalSubtitle');
      if (category==='academic'){
        const yearNames={year1:'ุงูุฃููู',year2:'ุงูุซุงููุฉ',year3:'ุงูุซุงูุซุฉ',year4:'ุงูุฑุงุจุนุฉ',year5:'ุงูุฎุงูุณุฉ',year6:'ุงูุณุงุฏุณุฉ'};
        const termNames={semester1:'ุงูุฃูู',semester2:'ุงูุซุงูู',summer:'ุงูุตููู'};
        title.textContent='ุฅุถุงูุฉ ูุงุฏุฉ ุฌุฏูุฏุฉ';
        subtitle.textContent=`ุงูุณูุฉ ${yearNames[yearKey]} โข ุงููุตู ${termNames[termOrType]}`;
      } else {
        const t = termOrType==='required'?'ุฅุฌุจุงุฑูุฉ':'ุญุฑุฉ';
        title.textContent='ุฅุถุงูุฉ ูุงุฏุฉ ุฌุงูุนุฉ';
        subtitle.textContent=`${t}`;
      }
    }
    function closeAddSubjectModal(){
      const m=document.getElementById('addSubjectModal'); m.classList.add('hidden'); m.classList.remove('flex');
      ['modalSubjectName','modalSubjectDescription','modalSubjectCode','modalSubjectHours','modalSubjectTeacher'].forEach(id=>document.getElementById(id).value='');
    }

    async function addSubjectToCategory(e){
      e.preventDefault();
      const name=document.getElementById('modalSubjectName').value.trim();
      const description=document.getElementById('modalSubjectDescription').value.trim();
      const code=document.getElementById('modalSubjectCode').value.trim();
      const hours=parseInt(document.getElementById('modalSubjectHours').value);
      const teacher=document.getElementById('modalSubjectTeacher').value.trim();
      if (!name || !description || !hours || !code || !teacher) return;

      const id = 'sub_'+Date.now();
      const newSub = { id, name, description, code, hours, teacher };

      if (currentModalContext.category==='academic'){
        organizedSubjects.academic[currentModalContext.yearKey][currentModalContext.termOrType].push(newSub);
        localStorage.setItem('organizedSubjects', JSON.stringify(organizedSubjects));
        loadSemesterSubjects(currentModalContext.yearKey, currentModalContext.termOrType);
      } else {
        organizedSubjects.university[currentModalContext.termOrType].push(newSub);
        localStorage.setItem('organizedSubjects', JSON.stringify(organizedSubjects));
        loadUniversityCategorySubjects(currentModalContext.termOrType);
      }

      // Push to Supabase if connected
      if (supabaseClient){
        try{
          const payload = {
            id,
            name, description, hours, code, teacher,
            category: currentModalContext.category,
            year: currentModalContext.category==='academic' ? parseInt(currentModalContext.yearKey.replace('year','')) : null,
            term: currentModalContext.category==='academic' ? currentModalContext.termOrType : null,
            uni_type: currentModalContext.category==='university' ? currentModalContext.termOrType : null,
            updated_at: new Date().toISOString()
          };
          await supabaseClient.from('subjects').upsert([payload], { onConflict:'id' });
        }catch(err){ console.warn(err); }
      }

      closeAddSubjectModal();
      showNotification('ุชูุช ุฅุถุงูุฉ ุงููุงุฏุฉ','success');
      updateCounters();
    }

    // View subject details
    function findSubjectById(subId){
      // search academic
      for (const y in organizedSubjects.academic){
        for (const t in organizedSubjects.academic[y]){
          const f = organizedSubjects.academic[y][t].find(s=>s.id===subId);
          if (f) return f;
        }
      }
      // search university
      for (const k in organizedSubjects.university){
        const f = organizedSubjects.university[k].find(s=>s.id===subId);
        if (f) return f;
      }
      return null;
    }
    function viewSubjectDetails(subId){
      const s=findSubjectById(subId); if(!s) return;
      currentSubjectForFiles = s;
      const m=document.getElementById('subjectDetailsModal'); m.classList.remove('hidden'); m.classList.add('flex');
      document.getElementById('subjectDetailsTitle').textContent=s.name;
      document.getElementById('subjectDetailsContent').innerHTML = `
        <div class="mb-2 text-gray-700">${s.description}</div>
        <div class="grid grid-cols-2 gap-3 text-sm text-gray-600">
          <div><i class="fas fa-code ml-1"></i>ุฑูุฒ: ${s.code}</div>
          <div><i class="fas fa-clock ml-1"></i>ุณุงุนุงุช: ${s.hours}</div>
          <div><i class="fas fa-user ml-1"></i>ุฃุณุชุงุฐ: ${s.teacher}</div>
        </div>`;
    }
    function closeSubjectDetailsModal(){
      const m=document.getElementById('subjectDetailsModal'); m.classList.add('hidden'); m.classList.remove('flex');
    }

    function quickOpenFiles(ev, subId, type){
      ev.stopPropagation();
      const s=findSubjectById(subId); if(!s) return; currentSubjectForFiles=s; openSubjectFiles(type);
    }

    async function openSubjectFiles(type){
      if (!currentSubjectForFiles) return;
      currentFileType = type;
      const titleMap={slides:'ุงูุณูุงูุฏุงุช', summaries:'ุงูุชูุงุฎูุต', recordings:'ุงูุฑูููุฑุฏุงุช'};
      document.getElementById('filesModalTitle').textContent = `${titleMap[type]} - ${currentSubjectForFiles.name}`;
      const c=document.getElementById('subjectFilesContent'); c.innerHTML = `<div class="text-gray-500">ุฌุงุฑู ุงูุชุญููู...</div>`;
      const addBtn=document.getElementById('addFileBtn'); addBtn.classList.toggle('hidden', !isAdmin);

      let files=[];
      if (supabaseClient){
        try{
          const { data, error } = await supabaseClient.from('subject_files').select('*').eq('subject_id', currentSubjectForFiles.id).eq('type', type).order('created_at', {ascending:false});
          if (!error) files = data || [];
        }catch(e){/* ignore */}
      }
      // Render
      if (!files.length){
        c.innerHTML=`<div class="text-center text-gray-500 py-6"><i class="fas fa-folder-open text-3xl mb-2"></i><p>ูุง ุชูุฌุฏ ูููุงุช</p></div>`;
      } else {
        c.innerHTML = '';
        files.forEach(f=>{
          const row=document.createElement('div');
          row.className='flex items-center justify-between p-3 bg-gray-50 rounded-lg';
          row.innerHTML = `
            <div class="flex items-center">
              <i class="fas fa-file text-gray-600 ml-3"></i>
              <div>
                <div class="font-semibold text-gray-800">${f.name}</div>
                <div class="text-xs text-gray-500">${new Date(f.created_at).toLocaleDateString('ar-SA')}</div>
              </div>
            </div>
            <div class="flex gap-2">
              <a href="${f.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800"><i class="fas fa-up-right-from-square"></i></a>
              ${isAdmin?`<button onclick="deleteFile('${f.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>`:''}
            </div>`;
          c.appendChild(row);
        });
      }

      const m=document.getElementById('subjectFilesModal'); m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeSubjectFilesModal(){ const m=document.getElementById('subjectFilesModal'); m.classList.add('hidden'); m.classList.remove('flex'); currentFileType=null; }
    async function addNewFile(){
      if (!isAdmin){ showNotification('ุงูุฅุถุงูุฉ ูููุฏูุฑ ููุท','error'); return; }
      if (!currentSubjectForFiles || !currentFileType){ showNotification('ุงูุชุญ ูุณู ุงููููุงุช ุฃููุงู','error'); return; }
      const name = prompt('ุงุณู ุงูููู:'); if (!name) return;
      const url  = prompt('ุฑุงุจุท ุงูููู (https):'); if (!url) return;
      if (supabaseClient){
        try{
          const { error } = await supabaseClient.from('subject_files').insert([{ subject_id: currentSubjectForFiles.id, type: currentFileType, name, url }]);
          if (error) throw error;
          showNotification('ุชูุช ุฅุถุงูุฉ ุงูููู','success');
        }catch(e){ console.warn(e); showNotification('ุชุนุฐุฑ ุฅุถุงูุฉ ุงูููู','error'); }
      } else {
        showNotification('ุงููููุงุช ุชูุญูุธ ูู Supabase ููุท. ูุนูู ุงูุงุชุตุงู ุฃููุงู','info');
      }
      openSubjectFiles(currentFileType);
    }
    async function deleteFile(fileId){
      if (!confirm('ุญุฐู ุงููููุ')) return;
      try{
        const { error } = await supabaseClient.from('subject_files').delete().eq('id', fileId);
        if (error) throw error;
        showNotification('ุชู ุญุฐู ุงูููู','success');
      }catch(e){ showNotification('ุชุนุฐุฑ ุงูุญุฐู','error'); }
      openSubjectFiles(currentFileType);
    }

    // Sync with Supabase for subjects
    async function syncSubjects(){
      if (!supabaseClient){ showNotification('ุฃุฏุฎู ุฅุนุฏุงุฏุงุช Supabase ุฃููุงู','error'); return; }
      try{
        // Pull subjects
        const { data, error } = await supabaseClient.from('subjects').select('*').limit(1000);
        if (error) throw error;
        // Rebuild organizedSubjects
        const fresh = {
          academic: {
            year1:{semester1:[], semester2:[], summer:[]},
            year2:{semester1:[], semester2:[], summer:[]},
            year3:{semester1:[], semester2:[], summer:[]},
            year4:{semester1:[], semester2:[], summer:[]},
            year5:{semester1:[], semester2:[], summer:[]},
            year6:{semester1:[], semester2:[], summer:[]}
          },
          university: { required:[], elective:[] }
        };
        (data||[]).forEach(row=>{
          const sub = { id: row.id, name: row.name, description: row.description, code: row.code, hours: row.hours, teacher: row.teacher };
          if (row.category==='academic' && row.year && row.term){
            const y='year'+row.year; fresh.academic[y][row.term].push(sub);
          } else if (row.category==='university' && row.uni_type){
            fresh.university[row.uni_type].push(sub);
          }
        });
        organizedSubjects = fresh;
        localStorage.setItem('organizedSubjects', JSON.stringify(organizedSubjects));
        showNotification('ุชูุช ูุฒุงููุฉ ุงูููุงุฏ','success');
        // refresh opened containers if any
        ['year1','year2','year3','year4','year5','year6'].forEach(y=>['semester1','semester2','summer'].forEach(t=>{
          const box=document.getElementById(y+t+'Content'); if (box && !box.classList.contains('hidden')) loadSemesterSubjects(y,t);
        }));
        ['required','elective'].forEach(t=>{
          const box=document.getElementById(t+'Content'); if (box && !box.classList.contains('hidden')) loadUniversityCategorySubjects(t);
        });
        updateCounters();
      }catch(e){ console.error(e); showNotification('ุชุนุฐุฑ ูุฒุงููุฉ ุงูููุงุฏ','error'); }
    }
    async function syncFilesPreview(){
      if (!supabaseClient){ showNotification('ุฃุฏุฎู ุฅุนุฏุงุฏุงุช Supabase ุฃููุงู','error'); return; }
      try{
        const { count, error } = await supabaseClient.from('subject_files').select('*', { count:'exact', head:true });
        if (error) throw error;
        showNotification(`ุฅุฌูุงูู ุงููููุงุช: ${count||0}`,'info');
        document.getElementById('filesCounter').textContent = count||0;
      }catch(e){ showNotification('ุชุนุฐุฑ ุฌูุจ ุนุฏุฏ ุงููููุงุช','error'); }
    }
    async function syncAll(){ await syncSubjects(); await syncFilesPreview(); }

    // Counters
    function updateCounters(){
      let total=0;
      for (const y in organizedSubjects.academic){ for (const t in organizedSubjects.academic[y]) total += organizedSubjects.academic[y][t].length; }
      total += organizedSubjects.university.required.length + organizedSubjects.university.elective.length;
      document.getElementById('subjectsCounter').textContent = total;
    }

    // GPA
    function updateGPA(){
      let pts=0, hrs=0;
      gpaEntries.forEach(e=>{ pts += e.hours*e.grade; hrs += e.hours; });
      const gpa = hrs>0 ? (pts/hrs).toFixed(2) : '0.00';
      document.getElementById('gpaResult').textContent=gpa;
      const c=document.getElementById('gpaSubjects'); c.innerHTML='';
      if (gpaEntries.length){
        const s=document.createElement('div');
        s.className='p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800 mb-2';
        s.innerHTML=`<div class="flex justify-between"><span>ุฅุฌูุงูู ุงูููุงุท</span><span>${pts.toFixed(2)}</span></div>
                     <div class="flex justify-between"><span>ุฅุฌูุงูู ุงูุณุงุนุงุช</span><span>${hrs}</span></div>
                     <div class="flex justify-between border-t mt-1 pt-1"><span>GPA</span><span class="font-bold">${gpa}</span></div>`;
        c.appendChild(s);
      }
      gpaEntries.forEach((e,i)=>{
        const row=document.createElement('div');
        row.className='flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        row.innerHTML=`<div><div class="font-semibold text-gray-800">${e.name}</div><div class="text-sm text-gray-600">${e.hours}ร${e.grade}=${(e.hours*e.grade).toFixed(2)}</div></div>
          <button onclick="removeGPA(${i})" class="text-red-600 hover:text-red-800"><i class="fas fa-times"></i></button>`;
        c.appendChild(row);
      });
      localStorage.setItem('gpaEntries', JSON.stringify(gpaEntries));
    }
    function addSubjectToGPA(){
      const name=document.getElementById('gpaSubjectName').value.trim();
      const hours=parseFloat(document.getElementById('creditHours').value);
      const grade=parseFloat(document.getElementById('grade').value);
      if(!name||!hours||!grade) return;
      gpaEntries.push({id:Date.now(),name,hours,grade,updated_at:new Date().toISOString()});
      document.getElementById('gpaSubjectName').value=''; document.getElementById('creditHours').value=''; document.getElementById('grade').value='';
      updateGPA();
    }
    function removeGPA(i){ gpaEntries.splice(i,1); updateGPA(); }

    // Tasks
    function loadTasks(){
      const c=document.getElementById('tasksList'); c.innerHTML='';
      tasks.forEach((t,i)=>{
        const row=document.createElement('div');
        row.className=`flex items-center justify-between p-3 ${t.completed?'bg-green-50':'bg-gray-50'} rounded-xl`;
        row.innerHTML=`<div class="flex items-center">
          <input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask(${i})" class="ml-3">
          <span class="${t.completed?'line-through text-gray-500':'text-gray-800'}">${t.text}</span></div>
          <button onclick="deleteTask(${i})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>`;
        c.appendChild(row);
      });
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }
    function addTask(){ const i=document.getElementById('newTask'); if(!i.value.trim()) return; tasks.push({id:Date.now(),text:i.value.trim(),completed:false}); i.value=''; loadTasks(); }
    function toggleTask(i){ tasks[i].completed=!tasks[i].completed; loadTasks(); }
    function deleteTask(i){ tasks.splice(i,1); loadTasks(); showNotification('ุชู ุญุฐู ุงููููุฉ','info'); }

    // Timer
    let timerInterval=null, timerMinutes=25, timerSeconds=0, isTimerRunning=false;
    function startTimer(){ if (isTimerRunning) return; isTimerRunning=true; timerInterval=setInterval(()=>{ if(timerSeconds===0){ if(timerMinutes===0){ resetTimer(); showNotification('ุงูุชูู ุงูููุช','info'); return;} timerMinutes--; timerSeconds=59;} else timerSeconds--; updateTimerDisplay(); },1000); }
    function pauseTimer(){ isTimerRunning=false; clearInterval(timerInterval); }
    function resetTimer(){ isTimerRunning=false; clearInterval(timerInterval); timerMinutes=25; timerSeconds=0; updateTimerDisplay(); }
    function setCustomTimer(){ const cm=document.getElementById('customMinutes'); if(cm.value){ timerMinutes=parseInt(cm.value); timerSeconds=0; updateTimerDisplay(); cm.value=''; } }
    function updateTimerDisplay(){ const d=document.getElementById('timerDisplay'); const m=String(timerMinutes).padStart(2,'0'), s=String(timerSeconds).padStart(2,'0'); d.textContent=`${m}:${s}`; }

    // Keyboard send
    document.addEventListener('keypress',(e)=>{ if(e.key==='Enter'){ const i=document.getElementById('messageInput'); if(i && !i.disabled) sendMessage(); } });

  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'984661a3040332aa',t:'MTc1ODc1OTg5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
